{"version":3,"sources":["../../src/utils/makeProxyAgent.ts"],"sourcesContent":["import { socksDispatcher } from 'fetch-socks';\nimport { HttpsProxyAgent } from 'https-proxy-agent';\nimport { SocksProxyAgent } from 'socks-proxy-agent';\nimport { ProxyAgent } from 'undici';\n\ntype Proxy = {\n  host: string;\n  password?: string;\n  port: string;\n  protocol: string;\n  username?: string;\n};\n\nfunction selectProxyAgent(proxyUrl: string): HttpsProxyAgent<string> | SocksProxyAgent {\n  const url = new URL(proxyUrl);\n\n  // NOTE: The following constants are not used in the function but are defined for clarity.\n  // When a proxy URL is used to build the URL object, the protocol returned by procotol's property contains a `:` at\n  // the end so, we add the protocol constants without the `:` to avoid confusion.\n  const PROXY_HTTP_PROTOCOL = 'http:';\n  const PROXY_SOCKS_PROTOCOL = 'socks:';\n  const PROXY_SOCKS5_PROTOCOL = 'socks5:';\n\n  switch (url.protocol) {\n    case PROXY_HTTP_PROTOCOL:\n      return new HttpsProxyAgent(url);\n    case PROXY_SOCKS_PROTOCOL:\n    case PROXY_SOCKS5_PROTOCOL: {\n      let urlSocks = '';\n\n      if (url.username && url.password) {\n        urlSocks = `socks://${url.username}:${url.password}@${url.hostname}:${url.port}`;\n      } else {\n        urlSocks = `socks://${url.hostname}:${url.port}`;\n      }\n\n      return new SocksProxyAgent(urlSocks);\n    }\n    default:\n      throw new Error(`Unsupported proxy protocol: ${url.protocol}`);\n  }\n}\n\nexport function makeProxyAgent(proxy: Proxy | string): HttpsProxyAgent<string> | SocksProxyAgent {\n  if (typeof proxy === 'string') {\n    return selectProxyAgent(proxy);\n  }\n\n  const { host, password, port, protocol, username } = proxy;\n  let proxyUrl = `${protocol}://${host}:${port}`;\n\n  if (username && password) {\n    proxyUrl = `${protocol}://${username}:${password}@${host}:${port}`;\n  }\n\n  return selectProxyAgent(proxyUrl);\n}\n\nexport function makeProxyAgentUndici(proxy: Proxy | string): ProxyAgent {\n  let proxyUrl: string;\n  let protocol: string;\n\n  if (typeof proxy === 'string') {\n    const url = new URL(proxy);\n    protocol = url.protocol.replace(':', '');\n    proxyUrl = proxy;\n  } else {\n    const { host, password, port, protocol: proto, username } = proxy;\n    protocol = (proto || 'http').replace(':', '');\n\n    if (protocol === 'socks') {\n      protocol = 'socks5';\n    }\n\n    const auth = username && password ? `${username}:${password}@` : '';\n    proxyUrl = `${protocol}://${auth}${host}:${port}`;\n  }\n\n  protocol = protocol.toLowerCase();\n\n  const PROXY_HTTP_PROTOCOL = 'http';\n  const PROXY_HTTPS_PROTOCOL = 'https';\n  const PROXY_SOCKS4_PROTOCOL = 'socks4';\n  const PROXY_SOCKS5_PROTOCOL = 'socks5';\n\n  switch (protocol) {\n    case PROXY_HTTP_PROTOCOL:\n    case PROXY_HTTPS_PROTOCOL:\n      return new ProxyAgent(proxyUrl);\n\n    case PROXY_SOCKS4_PROTOCOL:\n    case PROXY_SOCKS5_PROTOCOL: {\n      let type: 4 | 5 = 5;\n\n      if (PROXY_SOCKS4_PROTOCOL === protocol) type = 4;\n\n      const url = new URL(proxyUrl);\n\n      return socksDispatcher({\n        type: type,\n        host: url.hostname,\n        port: Number(url.port),\n        userId: url.username || undefined,\n        password: url.password || undefined,\n      });\n    }\n\n    default:\n      throw new Error(`Unsupported proxy protocol: ${protocol}`);\n  }\n}\n"],"mappings":"4ZAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,oBAAAE,EAAA,yBAAAC,IAAA,eAAAC,EAAAJ,GAAA,IAAAK,EAAgC,uBAChCC,EAAgC,6BAChCC,EAAgC,6BAChCC,EAA2B,kBAU3B,SAASC,EAAiBC,EAA6D,CACrF,IAAMC,EAAM,IAAI,IAAID,CAAQ,EAKtBE,EAAsB,QACtBC,EAAuB,SACvBC,EAAwB,UAE9B,OAAQH,EAAI,SAAU,CACpB,KAAKC,EACH,OAAO,IAAI,kBAAgBD,CAAG,EAChC,KAAKE,EACL,KAAKC,EAAuB,CAC1B,IAAIC,EAAW,GAEf,OAAIJ,EAAI,UAAYA,EAAI,SACtBI,EAAW,WAAWJ,EAAI,QAAQ,IAAIA,EAAI,QAAQ,IAAIA,EAAI,QAAQ,IAAIA,EAAI,IAAI,GAE9EI,EAAW,WAAWJ,EAAI,QAAQ,IAAIA,EAAI,IAAI,GAGzC,IAAI,kBAAgBI,CAAQ,CACrC,CACA,QACE,MAAM,IAAI,MAAM,+BAA+BJ,EAAI,QAAQ,EAAE,CACjE,CACF,CAEO,SAAST,EAAec,EAAkE,CAC/F,GAAI,OAAOA,GAAU,SACnB,OAAOP,EAAiBO,CAAK,EAG/B,GAAM,CAAE,KAAAC,EAAM,SAAAC,EAAU,KAAAC,EAAM,SAAAC,EAAU,SAAAC,CAAS,EAAIL,EACjDN,EAAW,GAAGU,CAAQ,MAAMH,CAAI,IAAIE,CAAI,GAE5C,OAAIE,GAAYH,IACdR,EAAW,GAAGU,CAAQ,MAAMC,CAAQ,IAAIH,CAAQ,IAAID,CAAI,IAAIE,CAAI,IAG3DV,EAAiBC,CAAQ,CAClC,CAEO,SAASP,EAAqBa,EAAmC,CACtE,IAAIN,EACAU,EAEJ,GAAI,OAAOJ,GAAU,SAEnBI,EADY,IAAI,IAAIJ,CAAK,EACV,SAAS,QAAQ,IAAK,EAAE,EACvCN,EAAWM,MACN,CACL,GAAM,CAAE,KAAAC,EAAM,SAAAC,EAAU,KAAAC,EAAM,SAAUG,EAAO,SAAAD,CAAS,EAAIL,EAC5DI,GAAYE,GAAS,QAAQ,QAAQ,IAAK,EAAE,EAExCF,IAAa,UACfA,EAAW,UAGb,IAAMG,EAAOF,GAAYH,EAAW,GAAGG,CAAQ,IAAIH,CAAQ,IAAM,GACjER,EAAW,GAAGU,CAAQ,MAAMG,CAAI,GAAGN,CAAI,IAAIE,CAAI,EACjD,CAEAC,EAAWA,EAAS,YAAY,EAEhC,IAAMR,EAAsB,OACtBY,EAAuB,QACvBC,EAAwB,SACxBX,EAAwB,SAE9B,OAAQM,EAAU,CAChB,KAAKR,EACL,KAAKY,EACH,OAAO,IAAI,aAAWd,CAAQ,EAEhC,KAAKe,EACL,KAAKX,EAAuB,CAC1B,IAAIY,EAAc,EAEdD,IAA0BL,IAAUM,EAAO,GAE/C,IAAMf,EAAM,IAAI,IAAID,CAAQ,EAE5B,SAAO,mBAAgB,CACrB,KAAMgB,EACN,KAAMf,EAAI,SACV,KAAM,OAAOA,EAAI,IAAI,EACrB,OAAQA,EAAI,UAAY,OACxB,SAAUA,EAAI,UAAY,MAC5B,CAAC,CACH,CAEA,QACE,MAAM,IAAI,MAAM,+BAA+BS,CAAQ,EAAE,CAC7D,CACF","names":["makeProxyAgent_exports","__export","makeProxyAgent","makeProxyAgentUndici","__toCommonJS","import_fetch_socks","import_https_proxy_agent","import_socks_proxy_agent","import_undici","selectProxyAgent","proxyUrl","url","PROXY_HTTP_PROTOCOL","PROXY_SOCKS_PROTOCOL","PROXY_SOCKS5_PROTOCOL","urlSocks","proxy","host","password","port","protocol","username","proto","auth","PROXY_HTTPS_PROTOCOL","PROXY_SOCKS4_PROTOCOL","type"]}