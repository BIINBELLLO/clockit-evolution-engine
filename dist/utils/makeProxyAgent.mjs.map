{"version":3,"sources":["../../src/utils/makeProxyAgent.ts"],"sourcesContent":["import { socksDispatcher } from 'fetch-socks';\nimport { HttpsProxyAgent } from 'https-proxy-agent';\nimport { SocksProxyAgent } from 'socks-proxy-agent';\nimport { ProxyAgent } from 'undici';\n\ntype Proxy = {\n  host: string;\n  password?: string;\n  port: string;\n  protocol: string;\n  username?: string;\n};\n\nfunction selectProxyAgent(proxyUrl: string): HttpsProxyAgent<string> | SocksProxyAgent {\n  const url = new URL(proxyUrl);\n\n  // NOTE: The following constants are not used in the function but are defined for clarity.\n  // When a proxy URL is used to build the URL object, the protocol returned by procotol's property contains a `:` at\n  // the end so, we add the protocol constants without the `:` to avoid confusion.\n  const PROXY_HTTP_PROTOCOL = 'http:';\n  const PROXY_SOCKS_PROTOCOL = 'socks:';\n  const PROXY_SOCKS5_PROTOCOL = 'socks5:';\n\n  switch (url.protocol) {\n    case PROXY_HTTP_PROTOCOL:\n      return new HttpsProxyAgent(url);\n    case PROXY_SOCKS_PROTOCOL:\n    case PROXY_SOCKS5_PROTOCOL: {\n      let urlSocks = '';\n\n      if (url.username && url.password) {\n        urlSocks = `socks://${url.username}:${url.password}@${url.hostname}:${url.port}`;\n      } else {\n        urlSocks = `socks://${url.hostname}:${url.port}`;\n      }\n\n      return new SocksProxyAgent(urlSocks);\n    }\n    default:\n      throw new Error(`Unsupported proxy protocol: ${url.protocol}`);\n  }\n}\n\nexport function makeProxyAgent(proxy: Proxy | string): HttpsProxyAgent<string> | SocksProxyAgent {\n  if (typeof proxy === 'string') {\n    return selectProxyAgent(proxy);\n  }\n\n  const { host, password, port, protocol, username } = proxy;\n  let proxyUrl = `${protocol}://${host}:${port}`;\n\n  if (username && password) {\n    proxyUrl = `${protocol}://${username}:${password}@${host}:${port}`;\n  }\n\n  return selectProxyAgent(proxyUrl);\n}\n\nexport function makeProxyAgentUndici(proxy: Proxy | string): ProxyAgent {\n  let proxyUrl: string;\n  let protocol: string;\n\n  if (typeof proxy === 'string') {\n    const url = new URL(proxy);\n    protocol = url.protocol.replace(':', '');\n    proxyUrl = proxy;\n  } else {\n    const { host, password, port, protocol: proto, username } = proxy;\n    protocol = (proto || 'http').replace(':', '');\n\n    if (protocol === 'socks') {\n      protocol = 'socks5';\n    }\n\n    const auth = username && password ? `${username}:${password}@` : '';\n    proxyUrl = `${protocol}://${auth}${host}:${port}`;\n  }\n\n  protocol = protocol.toLowerCase();\n\n  const PROXY_HTTP_PROTOCOL = 'http';\n  const PROXY_HTTPS_PROTOCOL = 'https';\n  const PROXY_SOCKS4_PROTOCOL = 'socks4';\n  const PROXY_SOCKS5_PROTOCOL = 'socks5';\n\n  switch (protocol) {\n    case PROXY_HTTP_PROTOCOL:\n    case PROXY_HTTPS_PROTOCOL:\n      return new ProxyAgent(proxyUrl);\n\n    case PROXY_SOCKS4_PROTOCOL:\n    case PROXY_SOCKS5_PROTOCOL: {\n      let type: 4 | 5 = 5;\n\n      if (PROXY_SOCKS4_PROTOCOL === protocol) type = 4;\n\n      const url = new URL(proxyUrl);\n\n      return socksDispatcher({\n        type: type,\n        host: url.hostname,\n        port: Number(url.port),\n        userId: url.username || undefined,\n        password: url.password || undefined,\n      });\n    }\n\n    default:\n      throw new Error(`Unsupported proxy protocol: ${protocol}`);\n  }\n}\n"],"mappings":"AAAA,OAAS,mBAAAA,MAAuB,cAChC,OAAS,mBAAAC,MAAuB,oBAChC,OAAS,mBAAAC,MAAuB,oBAChC,OAAS,cAAAC,MAAkB,SAU3B,SAASC,EAAiBC,EAA6D,CACrF,IAAMC,EAAM,IAAI,IAAID,CAAQ,EAKtBE,EAAsB,QACtBC,EAAuB,SACvBC,EAAwB,UAE9B,OAAQH,EAAI,SAAU,CACpB,KAAKC,EACH,OAAO,IAAIN,EAAgBK,CAAG,EAChC,KAAKE,EACL,KAAKC,EAAuB,CAC1B,IAAIC,EAAW,GAEf,OAAIJ,EAAI,UAAYA,EAAI,SACtBI,EAAW,WAAWJ,EAAI,QAAQ,IAAIA,EAAI,QAAQ,IAAIA,EAAI,QAAQ,IAAIA,EAAI,IAAI,GAE9EI,EAAW,WAAWJ,EAAI,QAAQ,IAAIA,EAAI,IAAI,GAGzC,IAAIJ,EAAgBQ,CAAQ,CACrC,CACA,QACE,MAAM,IAAI,MAAM,+BAA+BJ,EAAI,QAAQ,EAAE,CACjE,CACF,CAEO,SAASK,EAAeC,EAAkE,CAC/F,GAAI,OAAOA,GAAU,SACnB,OAAOR,EAAiBQ,CAAK,EAG/B,GAAM,CAAE,KAAAC,EAAM,SAAAC,EAAU,KAAAC,EAAM,SAAAC,EAAU,SAAAC,CAAS,EAAIL,EACjDP,EAAW,GAAGW,CAAQ,MAAMH,CAAI,IAAIE,CAAI,GAE5C,OAAIE,GAAYH,IACdT,EAAW,GAAGW,CAAQ,MAAMC,CAAQ,IAAIH,CAAQ,IAAID,CAAI,IAAIE,CAAI,IAG3DX,EAAiBC,CAAQ,CAClC,CAEO,SAASa,EAAqBN,EAAmC,CACtE,IAAIP,EACAW,EAEJ,GAAI,OAAOJ,GAAU,SAEnBI,EADY,IAAI,IAAIJ,CAAK,EACV,SAAS,QAAQ,IAAK,EAAE,EACvCP,EAAWO,MACN,CACL,GAAM,CAAE,KAAAC,EAAM,SAAAC,EAAU,KAAAC,EAAM,SAAUI,EAAO,SAAAF,CAAS,EAAIL,EAC5DI,GAAYG,GAAS,QAAQ,QAAQ,IAAK,EAAE,EAExCH,IAAa,UACfA,EAAW,UAGb,IAAMI,EAAOH,GAAYH,EAAW,GAAGG,CAAQ,IAAIH,CAAQ,IAAM,GACjET,EAAW,GAAGW,CAAQ,MAAMI,CAAI,GAAGP,CAAI,IAAIE,CAAI,EACjD,CAEAC,EAAWA,EAAS,YAAY,EAEhC,IAAMT,EAAsB,OACtBc,EAAuB,QACvBC,EAAwB,SACxBb,EAAwB,SAE9B,OAAQO,EAAU,CAChB,KAAKT,EACL,KAAKc,EACH,OAAO,IAAIlB,EAAWE,CAAQ,EAEhC,KAAKiB,EACL,KAAKb,EAAuB,CAC1B,IAAIc,EAAc,EAEdD,IAA0BN,IAAUO,EAAO,GAE/C,IAAMjB,EAAM,IAAI,IAAID,CAAQ,EAE5B,OAAOL,EAAgB,CACrB,KAAMuB,EACN,KAAMjB,EAAI,SACV,KAAM,OAAOA,EAAI,IAAI,EACrB,OAAQA,EAAI,UAAY,OACxB,SAAUA,EAAI,UAAY,MAC5B,CAAC,CACH,CAEA,QACE,MAAM,IAAI,MAAM,+BAA+BU,CAAQ,EAAE,CAC7D,CACF","names":["socksDispatcher","HttpsProxyAgent","SocksProxyAgent","ProxyAgent","selectProxyAgent","proxyUrl","url","PROXY_HTTP_PROTOCOL","PROXY_SOCKS_PROTOCOL","PROXY_SOCKS5_PROTOCOL","urlSocks","makeProxyAgent","proxy","host","password","port","protocol","username","makeProxyAgentUndici","proto","auth","PROXY_HTTPS_PROTOCOL","PROXY_SOCKS4_PROTOCOL","type"]}