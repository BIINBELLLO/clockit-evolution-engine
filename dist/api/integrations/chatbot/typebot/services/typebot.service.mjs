var V={WHATSAPP_BUSINESS:"WHATSAPP-BUSINESS",WHATSAPP_BAILEYS:"WHATSAPP-BAILEYS",EVOLUTION:"EVOLUTION"};import{isBooleanString as K}from"class-validator";import X from"dotenv";X.config();var f=class{constructor(){this.loadEnv()}get(E){return this.env[E]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:K(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:K(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}},I=new f;var J=n=>{let E;I.get("S3").ENABLE&&(I.get("S3").SAVE_VIDEO||n?.message?.videoMessage===void 0&&n?.message?.viewOnceMessageV2?.message?.videoMessage===void 0)?E=n.message?.mediaUrl:E=n.key?.id;let e={conversation:n?.message?.conversation,extendedTextMessage:n?.message?.extendedTextMessage?.text,contactMessage:n?.message?.contactMessage?.displayName,locationMessage:n?.message?.locationMessage?.degreesLatitude.toString(),viewOnceMessageV2:n?.message?.viewOnceMessageV2?.message?.imageMessage?.url||n?.message?.viewOnceMessageV2?.message?.videoMessage?.url||n?.message?.viewOnceMessageV2?.message?.audioMessage?.url,listResponseMessage:n?.message?.listResponseMessage?.title||n?.listResponseMessage?.title,responseRowId:n?.message?.listResponseMessage?.singleSelectReply?.selectedRowId,templateButtonReplyMessage:n?.message?.templateButtonReplyMessage?.selectedId||n?.message?.buttonsResponseMessage?.selectedButtonId,audioMessage:n?.message?.speechToText?n?.message?.speechToText:n?.message?.audioMessage?`audioMessage|${E}`:void 0,imageMessage:n?.message?.imageMessage?`imageMessage|${E}${n?.message?.imageMessage?.caption?`|${n?.message?.imageMessage?.caption}`:""}`:void 0,videoMessage:n?.message?.videoMessage?`videoMessage|${E}${n?.message?.videoMessage?.caption?`|${n?.message?.videoMessage?.caption}`:""}`:void 0,documentMessage:n?.message?.documentMessage?`documentMessage|${E}${n?.message?.documentMessage?.caption?`|${n?.message?.documentMessage?.caption}`:""}`:void 0,documentWithCaptionMessage:n?.message?.documentWithCaptionMessage?.message?.documentMessage?`documentWithCaptionMessage|${E}${n?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption?`|${n?.message?.documentWithCaptionMessage?.message?.documentMessage?.caption}`:""}`:void 0,externalAdReplyBody:n?.contextInfo?.externalAdReply?.body?`externalAdReplyBody|${n.contextInfo.externalAdReply.body}`:void 0},o=Object.keys(e).find(s=>e[s]!==void 0)||"unknown";return{...e,messageType:o}},k=n=>{let E=Object.keys(n).find(o=>o!=="externalAdReplyBody"&&n[o]!==void 0),e=E?n[E]:void 0;return n.externalAdReplyBody&&(e=e?`${e}
${n.externalAdReplyBody}`:n.externalAdReplyBody),e},x=n=>{let E=J(n);return k(E)};import q from"axios";import j from"fs";var Z=JSON.parse(j.readFileSync("./package.json","utf8")),l=async n=>{let E=I.get("TELEMETRY");if(!E.ENABLED||n==="/")return;let e={route:n,apiVersion:`${Z.version}`,timestamp:new Date},o=E.URL&&E.URL!==""?E.URL:"https://log.evolution-api.com/telemetry";q.post(o,e).then(()=>{}).catch(()=>{})};import M from"axios";import z from"dayjs";import ee from"fs";var Ee=JSON.parse(ee.readFileSync("./package.json","utf8")),W=n=>z(n).toDate().toString().replace(/\sGMT.+/,""),D=(t=>(t.LOG="\x1B[32m",t.INFO="\x1B[34m",t.WARN="\x1B[33m",t.ERROR="\x1B[31m",t.DEBUG="\x1B[36m",t.VERBOSE="\x1B[37m",t.DARK="\x1B[30m",t))(D||{});var Y=(t=>(t.LOG="\x1B[32m%s\x1B[0m",t.DARK="\x1B[30m%s\x1B[0m",t.INFO="\x1B[34m%s\x1B[0m",t.WARN="\x1B[33m%s\x1B[0m",t.ERROR="\x1B[31m%s\x1B[0m",t.DEBUG="\x1B[36m%s\x1B[0m",t.VERBOSE="\x1B[37m%s\x1B[0m",t))(Y||{}),w=(t=>(t.LOG="LOG",t.WARN="WARN",t.INFO="INFO",t.DARK="DARK",t.ERROR="ERROR",t.DEBUG="DEBUG",t.VERBOSE="VERBOSE",t))(w||{}),F=(t=>(t.LOG="\x1B[42m",t.INFO="\x1B[44m",t.WARN="\x1B[43m",t.DARK="\x1B[40m",t.ERROR="\x1B[41m",t.DEBUG="\x1B[46m",t.VERBOSE="\x1B[47m",t))(F||{}),b=class{constructor(E="Logger"){this.configService=I;this.instance=null;this.context=E}setContext(E){this.context=E}setInstance(E){this.instance=E}console(E,e){let o=[];this.configService.get("LOG").LEVEL.forEach(S=>o.push(w[S]));let s=typeof E;o.includes(e)&&(I.get("LOG").COLOR?(console.log("\x1B[1m"+Y[e],"[Evolution API]","\x1B[1m"+D[e],this.instance?`[${this.instance}]`:"","\x1B[1m"+D[e],`v${Ee.version}`,"\x1B[1m"+D[e],process.pid.toString(),"\x1B[0m","\x1B[1m"+D[e],"-","\x1B[1m\x1B[37m",`${W(Date.now())}  `,"\x1B[0m",D[e]+F[e]+"\x1B[1m",`${e} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,D[e]+"\x1B[1m",`[${s}]\x1B[0m`,D[e],s!=="object"?E:"","\x1B[0m"),s==="object"&&console.log(E,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${W(Date.now())}  `,`${e} `,`[${this.context}]`,`[${s}]`,E))}log(E){this.console(E,"LOG")}info(E){this.console(E,"INFO")}warn(E){this.console(E,"WARN")}error(E){this.console(E,"ERROR")}verbose(E){this.console(E,"VERBOSE")}debug(E){this.console(E,"DEBUG")}dark(E){this.console(E,"DARK")}};var v=class{constructor(E,e,o,s){this.waMonitor=E,this.prismaRepository=e,this.logger=new b(o),this.configService=s}isImageMessage(E){return E.includes("imageMessage")}isAudioMessage(E){return E.includes("audioMessage")}isJSON(E){try{return JSON.parse(E),!0}catch{return!1}}getMediaType(E){let e=E.split(".").pop()?.toLowerCase(),o=["jpg","jpeg","png","gif","bmp","webp"],s=["mp3","wav","aac","ogg"],S=["mp4","avi","mkv","mov"],T=["pdf","doc","docx","xls","xlsx","ppt","pptx","txt"];return o.includes(e||"")?"image":s.includes(e||"")?"audio":S.includes(e||"")?"video":T.includes(e||"")?"document":null}async createNewSession(E,e,o){try{let s=typeof e.pushName=="object"&&e.pushName?.pushName?e.pushName.pushName:typeof e.pushName=="string"?e.pushName:null,S=typeof e.remoteJid=="object"&&e.remoteJid?.remoteJid?e.remoteJid.remoteJid:e.remoteJid;return{session:await this.prismaRepository.integrationSession.create({data:{remoteJid:S,pushName:s,sessionId:S,status:"opened",awaitUser:!1,botId:e.botId,instanceId:E.instanceId,type:o}})}}catch(s){this.logger.error(s);return}}async process(E,e,o,s,S,T,t,_){try{if(!s){await this.initNewSession(E,e,o,S,s,T,t,_);return}if(s.status==="paused")return;let A=S?.keywordFinish||"",r=T.toLowerCase().trim();if(A.length>0&&r===A.toLowerCase()){await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}});return}await this.sendMessageToBot(E,s,S,o,e,t||"",T,_),await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"opened",awaitUser:!0}})}catch(A){this.logger.error(`Error in process: ${A}`);return}}async sendMessageWhatsApp(E,e,o,s,S=!0){if(!o)return;let T=/!?\[(.*?)\]\((.*?)\)/g,t="",_=0,A,r=s?.splitMessages??!1;for(;(A=T.exec(o))!==null;){let[p,a,N]=A,i=this.getMediaType(N),O=o.slice(_,A.index);if(O&&(t+=O),i){t.trim()&&(await this.sendFormattedText(E,e,t.trim(),s,r,S),t="");try{i==="audio"?await E.audioWhatsapp({number:e.includes("@lid")?e:e.split("@")[0],delay:s?.delayMessage||1e3,audio:N,caption:a}):await E.mediaMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:s?.delayMessage||1e3,mediatype:i,media:N,caption:a,fileName:i==="document"?a||"document":void 0},null,!1)}catch(d){this.logger.error(`Error sending media: ${d}`),t+=`${a}: ${N}`}}else t+=p;_=T.lastIndex}if(_<o.length){let p=o.slice(_);p.trim()&&(t+=p)}t.trim()&&await this.sendFormattedText(E,e,t.trim(),s,r,S)}splitMessageByDoubleLineBreaks(E){return E.split(`

`).filter(e=>e.trim().length>0)}async sendSingleMessage(E,e,o,s,S=!0){let T=s?.timePerChar??0,A=Math.min(Math.max(o.length*T,1e3),2e4);this.logger.debug(`[BaseChatbot] Sending single message with linkPreview: ${S}`),E.integration===V.WHATSAPP_BAILEYS&&(await E.client.presenceSubscribe(e),await E.client.sendPresenceUpdate("composing",e)),await new Promise(r=>{setTimeout(async()=>{await E.textMessage({number:e.includes("@lid")?e:e.split("@")[0],delay:s?.delayMessage||1e3,text:o,linkPreview:S},!1),r()},A)}),E.integration===V.WHATSAPP_BAILEYS&&await E.client.sendPresenceUpdate("paused",e)}async sendFormattedText(E,e,o,s,S,T=!0){if(S){let t=this.splitMessageByDoubleLineBreaks(o);this.logger.debug(`[BaseChatbot] Splitting message into ${t.length} parts`);for(let _=0;_<t.length;_++){let A=t[_];this.logger.debug(`[BaseChatbot] Sending message part ${_+1}/${t.length}`),await this.sendSingleMessage(E,e,A,s,T)}this.logger.debug("[BaseChatbot] All message parts sent successfully")}else this.logger.debug("[BaseChatbot] Sending single message"),await this.sendSingleMessage(E,e,o,s,T)}async initNewSession(E,e,o,s,S,T,t,_){if(!S){let A=typeof t=="object"&&t?.pushName?t.pushName:typeof t=="string"?t:null,r=await this.createNewSession({instanceName:E.instanceName,instanceId:E.instanceId},{remoteJid:e,pushName:A,botId:o.id},this.getBotType());if(!r||!r.session){this.logger.error("Failed to create new session");return}S=r.session}await this.prismaRepository.integrationSession.update({where:{id:S.id},data:{status:"opened",awaitUser:!1}}),await this.sendMessageToBot(E,S,s,o,e,t||"",T,_)}};var Q=class extends v{constructor(E,e,o,s){super(E,o,"TypebotService",e),this.openaiService=s}getBotType(){return"typebot"}async sendMessageToBot(E,e,o,s,S,T,t,_){await this.processTypebot(E,S,_,e,s,s.url,o.expire,s.typebot,o.keywordFinish,o.delayMessage,o.unknownMessage,o.listeningFromMe,o.stopBotFromMe,o.keepOpen,t)}async processTypebotSimple(E,e,o,s,S,T,t,_){return this.process(E,e,o,s,S,T,t,_)}async createNewSession(E,e){if(e.remoteJid==="status@broadcast")return;let o=Math.floor(Math.random()*1e10).toString();try{let s=this.configService.get("TYPEBOT").API_VERSION,S,T;s==="latest"?(S=`${e.url}/api/v1/typebots/${e.typebot}/startChat`,T={prefilledVariables:{...e.prefilledVariables,remoteJid:e.remoteJid,pushName:e.pushName||e.prefilledVariables?.pushName||"",instanceName:E.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:E.number}}):(S=`${e.url}/api/v1/sendMessage`,T={startParams:{publicId:e.typebot,prefilledVariables:{...e.prefilledVariables,remoteJid:e.remoteJid,pushName:e.pushName||e.prefilledVariables?.pushName||"",instanceName:E.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:E.number}}});let t=await M.post(S,T),_=null;t?.data?.sessionId&&(_=await this.prismaRepository.integrationSession.create({data:{remoteJid:e.remoteJid,pushName:e.pushName||"",sessionId:`${o}-${t.data.sessionId}`,status:"opened",parameters:{...e.prefilledVariables,remoteJid:e.remoteJid,pushName:e.pushName||"",instanceName:E.name,serverUrl:this.configService.get("SERVER").URL,apiKey:this.configService.get("AUTHENTICATION").API_KEY.KEY,ownerJid:E.number},awaitUser:!1,botId:e.botId,type:"typebot",Instance:{connect:{id:E.id}}}}));let A={remoteJid:e.remoteJid,status:"opened",session:_};return this.waMonitor.waInstances[E.name].sendDataWebhook("typebot.change-status",A),{...t.data,session:_}}catch(s){this.logger.error(s);return}}async sendWAMessage(E,e,o,s,S,T,t){let _=this.waMonitor.waInstances[E.name];await this.processMessages(_,e,o,S,T,t,this.applyFormatting.bind(this),this.prismaRepository).catch(A=>{console.error("Erro ao processar mensagens:",A)})}applyFormatting(E){let e="";if(E.text&&(e+=E.text),E.children&&E.type!=="a")for(let S of E.children)e+=this.applyFormatting(S);E.type==="p"&&E.type!=="inline-variable"&&(e=e.trim()+`
`),E.type==="inline-variable"&&(e=e.trim()),E.type==="ol"&&(e=`
`+e.split(`
`).map((S,T)=>S?`${T+1}. ${S}`:"").join(`
`)),E.type==="li"&&(e=e.split(`
`).map(S=>S?`  ${S}`:"").join(`
`));let o="";E.bold&&(o+="*"),E.italic&&(o+="_"),E.underline&&(o+="~");let s=`${o}${e}${o.split("").reverse().join("")}`;return E.url&&(s=E.children[0]?.text?`[${s}]
(${E.url})`:`${E.url}`),s}async processMessages(E,e,o,s,S,T,t,_){let A=(r,p)=>{if(!r)return null;for(let a of r)if(a.lastBubbleBlockId===p)return a.wait?.secondsToWaitFor;return null};for(let r of s){if(r.type==="text"){let a="";for(let N of r.content.richText){for(let i of N.children)a+=t(i);a+=`
`}a=a.replace(/\*\*/g,"").replace(/__/,"").replace(/~~/,"").replace(/\n$/,""),a=a.replace(/\n$/,""),a.includes("[list]")?await this.processListMessage(E,a,e.remoteJid):a.includes("[buttons]")?await this.processButtonMessage(E,a,e.remoteJid):await this.sendMessageWhatsApp(E,e.remoteJid,a,o,!0),l("/message/sendText")}r.type==="image"&&(await E.mediaMessage({number:e.remoteJid,delay:o?.delayMessage||1e3,mediatype:"image",media:r.content.url},null,!1),l("/message/sendMedia")),r.type==="video"&&(await E.mediaMessage({number:e.remoteJid,delay:o?.delayMessage||1e3,mediatype:"video",media:r.content.url},null,!1),l("/message/sendMedia")),r.type==="audio"&&(await E.audioWhatsapp({number:e.remoteJid,delay:o?.delayMessage||1e3,encoding:!0,audio:r.content.url},!1),l("/message/sendWhatsAppAudio"));let p=A(T,r.id);p&&await new Promise(a=>setTimeout(a,p*1e3))}if(S){if(S.type==="choice input"){let r="",p=S.items;for(let a of p)r+=`\u25B6\uFE0F ${a.content}
`;r=r.replace(/\n$/,""),r.includes("[list]")?await this.processListMessage(E,r,e.remoteJid):r.includes("[buttons]")?await this.processButtonMessage(E,r,e.remoteJid):await this.sendMessageWhatsApp(E,e.remoteJid,r,o,!0),l("/message/sendText")}await _.integrationSession.update({where:{id:e.id},data:{awaitUser:!0}})}else{let r="closed";o?.keepOpen?await _.integrationSession.update({where:{id:e.id},data:{status:"closed"}}):(await _.integrationSession.deleteMany({where:{id:e.id}}),r="delete");let p={remoteJid:e.remoteJid,status:r,session:e};E.sendDataWebhook("typebot.change-status",p)}}async processListMessage(E,e,o){let s={number:o,title:"",description:"",buttonText:"",footerText:"",sections:[]},S=e.match(/\[title\]([\s\S]*?)(?=\[description\])/),T=e.match(/\[description\]([\s\S]*?)(?=\[buttonText\])/),t=e.match(/\[buttonText\]([\s\S]*?)(?=\[footerText\])/),_=e.match(/\[footerText\]([\s\S]*?)(?=\[menu\])/);S&&(s.title=S[1].trim()),T&&(s.description=T[1].trim()),t&&(s.buttonText=t[1].trim()),_&&(s.footerText=_[1].trim());let A=e.match(/\[menu\]([\s\S]*?)\[\/menu\]/)?.[1];if(A){let r=A.match(/\[section\]([\s\S]*?)(?=\[section\]|\[\/section\]|\[\/menu\])/g);r&&r.forEach(p=>{let a=p.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),N=p.match(/\[row\]([\s\S]*?)(?=\[row\]|\[\/row\]|\[\/section\]|\[\/menu\])/g),i={title:a,rows:N?.map(O=>({title:O.match(/title: (.*?)(?:\n|$)/)?.[1]?.trim(),description:O.match(/description: (.*?)(?:\n|$)/)?.[1]?.trim(),rowId:O.match(/rowId: (.*?)(?:\n|$)/)?.[1]?.trim()}))||[]};s.sections.push(i)})}await E.listMessage(s)}async processButtonMessage(E,e,o){let s={number:o,thumbnailUrl:void 0,title:"",description:"",footer:"",buttons:[]},S=e.match(/\[thumbnailUrl\]([\s\S]*?)(?=\[title\])/),T=e.match(/\[title\]([\s\S]*?)(?=\[description\])/),t=e.match(/\[description\]([\s\S]*?)(?=\[footer\])/),_=e.match(/\[footer\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url))/);T&&(s.title=T[1].trim()),S&&(s.thumbnailUrl=S[1].trim()),t&&(s.description=t[1].trim()),_&&(s.footer=_[1].trim());let A={reply:/\[reply\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,pix:/\[pix\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,copy:/\[copy\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,call:/\[call\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g,url:/\[url\]([\s\S]*?)(?=\[(?:reply|pix|copy|call|url)|$)/g};for(let[r,p]of Object.entries(A)){let a;for(;(a=p.exec(e))!==null;){let N=a[1].trim(),i={type:r};switch(r){case"pix":i.currency=N.match(/currency: (.*?)(?:\n|$)/)?.[1]?.trim(),i.name=N.match(/name: (.*?)(?:\n|$)/)?.[1]?.trim(),i.keyType=N.match(/keyType: (.*?)(?:\n|$)/)?.[1]?.trim(),i.key=N.match(/key: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"reply":i.displayText=N.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),i.id=N.match(/id: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"copy":i.displayText=N.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),i.copyCode=N.match(/copyCode: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"call":i.displayText=N.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),i.phoneNumber=N.match(/phone: (.*?)(?:\n|$)/)?.[1]?.trim();break;case"url":i.displayText=N.match(/displayText: (.*?)(?:\n|$)/)?.[1]?.trim(),i.url=N.match(/url: (.*?)(?:\n|$)/)?.[1]?.trim();break}Object.keys(i).length>1&&s.buttons.push(i)}}await E.buttonMessage(s)}async processTypebot(E,e,o,s,S,T,t,_,A,r,p,a,N,i,O,d){let C=await this.prismaRepository.instance.findFirst({where:{name:E.instanceName}});if(!C){this.logger.error("Instance not found in database");return}if(s&&t&&t>0){let c=Date.now(),P=new Date(s.updatedAt).getTime(),u=c-P;if(Math.floor(u/1e3/60)>t){i?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):await this.prismaRepository.integrationSession.deleteMany({where:{botId:S.id,remoteJid:e}});let R=await this.createNewSession(C,{enabled:S?.enabled,url:T,typebot:_,expire:t,keywordFinish:A,delayMessage:r,unknownMessage:p,listeningFromMe:a,remoteJid:e,pushName:o.pushName,botId:S.id,prefilledVariables:d});if(R?.session&&(s=R.session),!R?.messages||R.messages.length===0){let m=x(o.message);if(!m){p&&(await this.sendMessageWhatsApp(E,e,p,{delayMessage:r,expire:t,keywordFinish:A,listeningFromMe:a,stopBotFromMe:N,keepOpen:i,unknownMessage:p},!0),l("/message/sendText"));return}if(A&&m.toLowerCase()===A.toLowerCase()){let g="closed";i?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):(g="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:S.id,remoteJid:e}}));let U={remoteJid:e,status:g,session:s};E.sendDataWebhook("typebot.change-status",U);return}try{let g=this.configService.get("TYPEBOT").API_VERSION,U,h;g==="latest"?(U=`${T}/api/v1/sessions/${R?.sessionId}/continueChat`,h={message:m}):(U=`${T}/api/v1/sendMessage`,h={message:m,sessionId:R?.sessionId});let H=await M.post(U,h);await this.sendWAMessage(C,s,{expire:t,keywordFinish:A,delayMessage:r,unknownMessage:p,listeningFromMe:a,stopBotFromMe:N,keepOpen:i},e,H?.data?.messages,H?.data?.input,H?.data?.clientSideActions)}catch(g){this.logger.error(g);return}}R?.messages&&R.messages.length>0&&await this.sendWAMessage(C,s,{expire:t,keywordFinish:A,delayMessage:r,unknownMessage:p,listeningFromMe:a,stopBotFromMe:N,keepOpen:i},e,R.messages,R.input,R.clientSideActions);return}}if(s&&s.status!=="opened")return;if(!s){let c=await this.createNewSession(C,{enabled:S?.enabled,url:T,typebot:_,expire:t,keywordFinish:A,delayMessage:r,unknownMessage:p,listeningFromMe:a,remoteJid:e,pushName:o?.pushName,botId:S.id,prefilledVariables:d});if(c?.session&&(s=c.session),c?.messages&&c.messages.length>0&&await this.sendWAMessage(C,s,{expire:t,keywordFinish:A,delayMessage:r,unknownMessage:p,listeningFromMe:a,stopBotFromMe:N,keepOpen:i},e,c.messages,c.input,c.clientSideActions),!c?.messages||c.messages.length===0){if(!O){p&&(await this.sendMessageWhatsApp(E,e,p,{delayMessage:r,expire:t,keywordFinish:A,listeningFromMe:a,stopBotFromMe:N,keepOpen:i,unknownMessage:p},!0),l("/message/sendText"));return}if(A&&O.toLowerCase()===A.toLowerCase()){let u="closed";i?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):(u="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:S.id,remoteJid:e}}));let L={remoteJid:e,status:u,session:s};E.sendDataWebhook("typebot.change-status",L);return}let P;try{let u=this.configService.get("TYPEBOT").API_VERSION,L,R;u==="latest"?(L=`${T}/api/v1/sessions/${c?.sessionId}/continueChat`,R={message:O}):(L=`${T}/api/v1/sendMessage`,R={message:O,sessionId:c?.sessionId}),P=await M.post(L,R),await this.sendWAMessage(C,s,{expire:t,keywordFinish:A,delayMessage:r,unknownMessage:p,listeningFromMe:a,stopBotFromMe:N,keepOpen:i},e,P?.data?.messages,P?.data?.input,P?.data?.clientSideActions)}catch(u){this.logger.error(u);return}}return}if(await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"opened",awaitUser:!1}}),!O){p&&(await this.sendMessageWhatsApp(E,e,p,{delayMessage:r,expire:t,keywordFinish:A,listeningFromMe:a,stopBotFromMe:N,keepOpen:i,unknownMessage:p},!0),l("/message/sendText"));return}if(A&&O.toLowerCase()===A.toLowerCase()){let c="closed";i?await this.prismaRepository.integrationSession.update({where:{id:s.id},data:{status:"closed"}}):(c="delete",await this.prismaRepository.integrationSession.deleteMany({where:{botId:S.id,remoteJid:e}}));let P={remoteJid:e,status:c,session:s};E.sendDataWebhook("typebot.change-status",P);return}let $=this.configService.get("TYPEBOT").API_VERSION,G,B;if($==="latest"?(G=`${T}/api/v1/sessions/${s.sessionId.split("-")[1]}/continueChat`,B={message:O}):(G=`${T}/api/v1/sendMessage`,B={message:O,sessionId:s.sessionId.split("-")[1]}),this.isAudioMessage(O)&&o)try{this.logger.debug("[TypeBot] Downloading audio for Whisper transcription");let c=await this.openaiService.speechToText(o,C);c&&(B.message=`[audio] ${c}`)}catch(c){this.logger.error(`[TypeBot] Failed to transcribe audio: ${c}`)}let y=await M.post(G,B);await this.sendWAMessage(C,s,{expire:t,keywordFinish:A,delayMessage:r,unknownMessage:p,listeningFromMe:a,stopBotFromMe:N,keepOpen:i},e,y?.data?.messages,y?.data?.input,y?.data?.clientSideActions)}};export{Q as TypebotService};
//# sourceMappingURL=typebot.service.mjs.map