var de=Object.create;var K=Object.defineProperty;var Ce=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var Ie=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var he=(C,e)=>{for(var t in e)K(C,t,{get:e[t],enumerable:!0})},oe=(C,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Ne(e))!me.call(C,a)&&a!==t&&K(C,a,{get:()=>e[a],enumerable:!(s=Ce(e,a))||s.enumerable});return C};var D=(C,e,t)=>(t=C!=null?de(Ie(C)):{},oe(e||!C||!C.__esModule?K(t,"default",{value:C,enumerable:!0}):t,C)),Oe=C=>oe(K({},"__esModule",{value:!0}),C);var Le={};he(Le,{ChatwootService:()=>se});module.exports=Oe(Le);var Y=require("class-validator"),ae=D(require("dotenv"));ae.default.config();var G=class{constructor(){this.loadEnv()}get(e){return this.env[e]}loadEnv(){this.env=this.envProcess(),this.env.PRODUCTION=process.env?.NODE_ENV==="PROD",process.env?.DOCKER_ENV==="true"&&(this.env.SERVER.TYPE=process.env.SERVER_TYPE,this.env.SERVER.PORT=Number.parseInt(process.env.SERVER_PORT)||8080)}envProcess(){return{SERVER:{NAME:process.env?.SERVER_NAME||"evolution",TYPE:process.env.SERVER_TYPE||"http",PORT:Number.parseInt(process.env.SERVER_PORT)||8080,URL:process.env.SERVER_URL,DISABLE_DOCS:process.env?.SERVER_DISABLE_DOCS==="true",DISABLE_MANAGER:process.env?.SERVER_DISABLE_MANAGER==="true"},CORS:{ORIGIN:process.env.CORS_ORIGIN?.split(",")||["*"],METHODS:process.env.CORS_METHODS?.split(",")||["POST","GET","PUT","DELETE"],CREDENTIALS:process.env?.CORS_CREDENTIALS==="true"},SSL_CONF:{PRIVKEY:process.env?.SSL_CONF_PRIVKEY||"",FULLCHAIN:process.env?.SSL_CONF_FULLCHAIN||""},PROVIDER:{ENABLED:process.env?.PROVIDER_ENABLED==="true",HOST:process.env.PROVIDER_HOST,PORT:process.env?.PROVIDER_PORT||"5656",PREFIX:process.env?.PROVIDER_PREFIX||"evolution"},DATABASE:{CONNECTION:{URI:process.env.DATABASE_CONNECTION_URI||"",CLIENT_NAME:process.env.DATABASE_CONNECTION_CLIENT_NAME||"evolution"},PROVIDER:process.env.DATABASE_PROVIDER||"postgresql",SAVE_DATA:{INSTANCE:process.env?.DATABASE_SAVE_DATA_INSTANCE==="true",NEW_MESSAGE:process.env?.DATABASE_SAVE_DATA_NEW_MESSAGE==="true",MESSAGE_UPDATE:process.env?.DATABASE_SAVE_MESSAGE_UPDATE==="true",CONTACTS:process.env?.DATABASE_SAVE_DATA_CONTACTS==="true",CHATS:process.env?.DATABASE_SAVE_DATA_CHATS==="true",HISTORIC:process.env?.DATABASE_SAVE_DATA_HISTORIC==="true",LABELS:process.env?.DATABASE_SAVE_DATA_LABELS==="true",IS_ON_WHATSAPP:process.env?.DATABASE_SAVE_IS_ON_WHATSAPP==="true",IS_ON_WHATSAPP_DAYS:Number.parseInt(process.env?.DATABASE_SAVE_IS_ON_WHATSAPP_DAYS??"7")},DELETE_DATA:{LOGICAL_MESSAGE_DELETE:process.env?.DATABASE_DELETE_MESSAGE==="true"}},RABBITMQ:{ENABLED:process.env?.RABBITMQ_ENABLED==="true",GLOBAL_ENABLED:process.env?.RABBITMQ_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.RABBITMQ_PREFIX_KEY,EXCHANGE_NAME:process.env?.RABBITMQ_EXCHANGE_NAME||"evolution_exchange",URI:process.env.RABBITMQ_URI||"",FRAME_MAX:Number.parseInt(process.env.RABBITMQ_FRAME_MAX)||8192,EVENTS:{APPLICATION_STARTUP:process.env?.RABBITMQ_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.RABBITMQ_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.RABBITMQ_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.RABBITMQ_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.RABBITMQ_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.RABBITMQ_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.RABBITMQ_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.RABBITMQ_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.RABBITMQ_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.RABBITMQ_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.RABBITMQ_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.RABBITMQ_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.RABBITMQ_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.RABBITMQ_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.RABBITMQ_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.RABBITMQ_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.RABBITMQ_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.RABBITMQ_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.RABBITMQ_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.RABBITMQ_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.RABBITMQ_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.RABBITMQ_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.RABBITMQ_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.RABBITMQ_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.RABBITMQ_EVENTS_CALL==="true",TYPEBOT_START:process.env?.RABBITMQ_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.RABBITMQ_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},NATS:{ENABLED:process.env?.NATS_ENABLED==="true",GLOBAL_ENABLED:process.env?.NATS_GLOBAL_ENABLED==="true",PREFIX_KEY:process.env?.NATS_PREFIX_KEY,EXCHANGE_NAME:process.env?.NATS_EXCHANGE_NAME||"evolution_exchange",URI:process.env.NATS_URI||"",EVENTS:{APPLICATION_STARTUP:process.env?.NATS_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.NATS_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.NATS_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.NATS_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.NATS_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.NATS_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.NATS_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.NATS_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.NATS_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.NATS_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.NATS_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.NATS_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.NATS_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.NATS_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.NATS_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.NATS_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.NATS_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.NATS_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.NATS_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.NATS_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.NATS_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.NATS_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.NATS_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.NATS_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.NATS_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.NATS_EVENTS_CALL==="true",TYPEBOT_START:process.env?.NATS_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.NATS_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},SQS:{ENABLED:process.env?.SQS_ENABLED==="true",GLOBAL_ENABLED:process.env?.SQS_GLOBAL_ENABLED==="true",GLOBAL_FORCE_SINGLE_QUEUE:process.env?.SQS_GLOBAL_FORCE_SINGLE_QUEUE==="true",GLOBAL_PREFIX_NAME:process.env?.SQS_GLOBAL_PREFIX_NAME||"global",ACCESS_KEY_ID:process.env.SQS_ACCESS_KEY_ID||"",SECRET_ACCESS_KEY:process.env.SQS_SECRET_ACCESS_KEY||"",ACCOUNT_ID:process.env.SQS_ACCOUNT_ID||"",REGION:process.env.SQS_REGION||"",MAX_PAYLOAD_SIZE:Number.parseInt(process.env.SQS_MAX_PAYLOAD_SIZE??"1048576"),EVENTS:{APPLICATION_STARTUP:process.env?.SQS_GLOBAL_APPLICATION_STARTUP==="true",CALL:process.env?.SQS_GLOBAL_CALL==="true",CHATS_DELETE:process.env?.SQS_GLOBAL_CHATS_DELETE==="true",CHATS_SET:process.env?.SQS_GLOBAL_CHATS_SET==="true",CHATS_UPDATE:process.env?.SQS_GLOBAL_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.SQS_GLOBAL_CHATS_UPSERT==="true",CONNECTION_UPDATE:process.env?.SQS_GLOBAL_CONNECTION_UPDATE==="true",CONTACTS_SET:process.env?.SQS_GLOBAL_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.SQS_GLOBAL_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.SQS_GLOBAL_CONTACTS_UPSERT==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.SQS_GLOBAL_GROUP_PARTICIPANTS_UPDATE==="true",GROUPS_UPDATE:process.env?.SQS_GLOBAL_GROUPS_UPDATE==="true",GROUPS_UPSERT:process.env?.SQS_GLOBAL_GROUPS_UPSERT==="true",LABELS_ASSOCIATION:process.env?.SQS_GLOBAL_LABELS_ASSOCIATION==="true",LABELS_EDIT:process.env?.SQS_GLOBAL_LABELS_EDIT==="true",LOGOUT_INSTANCE:process.env?.SQS_GLOBAL_LOGOUT_INSTANCE==="true",MESSAGES_DELETE:process.env?.SQS_GLOBAL_MESSAGES_DELETE==="true",MESSAGES_EDITED:process.env?.SQS_GLOBAL_MESSAGES_EDITED==="true",MESSAGES_SET:process.env?.SQS_GLOBAL_MESSAGES_SET==="true",MESSAGES_UPDATE:process.env?.SQS_GLOBAL_MESSAGES_UPDATE==="true",MESSAGES_UPSERT:process.env?.SQS_GLOBAL_MESSAGES_UPSERT==="true",PRESENCE_UPDATE:process.env?.SQS_GLOBAL_PRESENCE_UPDATE==="true",QRCODE_UPDATED:process.env?.SQS_GLOBAL_QRCODE_UPDATED==="true",REMOVE_INSTANCE:process.env?.SQS_GLOBAL_REMOVE_INSTANCE==="true",SEND_MESSAGE:process.env?.SQS_GLOBAL_SEND_MESSAGE==="true",TYPEBOT_CHANGE_STATUS:process.env?.SQS_GLOBAL_TYPEBOT_CHANGE_STATUS==="true",TYPEBOT_START:process.env?.SQS_GLOBAL_TYPEBOT_START==="true"}},KAFKA:{ENABLED:process.env?.KAFKA_ENABLED==="true",CLIENT_ID:process.env?.KAFKA_CLIENT_ID||"evolution-api",BROKERS:process.env?.KAFKA_BROKERS?.split(",")||["localhost:9092"],CONNECTION_TIMEOUT:Number.parseInt(process.env?.KAFKA_CONNECTION_TIMEOUT||"3000"),REQUEST_TIMEOUT:Number.parseInt(process.env?.KAFKA_REQUEST_TIMEOUT||"30000"),GLOBAL_ENABLED:process.env?.KAFKA_GLOBAL_ENABLED==="true",CONSUMER_GROUP_ID:process.env?.KAFKA_CONSUMER_GROUP_ID||"evolution-api-consumers",TOPIC_PREFIX:process.env?.KAFKA_TOPIC_PREFIX||"evolution",NUM_PARTITIONS:Number.parseInt(process.env?.KAFKA_NUM_PARTITIONS||"1"),REPLICATION_FACTOR:Number.parseInt(process.env?.KAFKA_REPLICATION_FACTOR||"1"),AUTO_CREATE_TOPICS:process.env?.KAFKA_AUTO_CREATE_TOPICS==="true",EVENTS:{APPLICATION_STARTUP:process.env?.KAFKA_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.KAFKA_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.KAFKA_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.KAFKA_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.KAFKA_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.KAFKA_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.KAFKA_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.KAFKA_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.KAFKA_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.KAFKA_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.KAFKA_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.KAFKA_EVENTS_CONTACTS_SET==="true",CONTACTS_UPSERT:process.env?.KAFKA_EVENTS_CONTACTS_UPSERT==="true",CONTACTS_UPDATE:process.env?.KAFKA_EVENTS_CONTACTS_UPDATE==="true",PRESENCE_UPDATE:process.env?.KAFKA_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.KAFKA_EVENTS_CHATS_SET==="true",CHATS_UPSERT:process.env?.KAFKA_EVENTS_CHATS_UPSERT==="true",CHATS_UPDATE:process.env?.KAFKA_EVENTS_CHATS_UPDATE==="true",CHATS_DELETE:process.env?.KAFKA_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.KAFKA_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.KAFKA_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.KAFKA_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.KAFKA_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.KAFKA_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.KAFKA_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.KAFKA_EVENTS_CALL==="true",TYPEBOT_START:process.env?.KAFKA_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.KAFKA_EVENTS_TYPEBOT_CHANGE_STATUS==="true"},SASL:process.env?.KAFKA_SASL_ENABLED==="true"?{ENABLED:!0,MECHANISM:process.env?.KAFKA_SASL_MECHANISM||"plain",USERNAME:process.env?.KAFKA_SASL_USERNAME||"",PASSWORD:process.env?.KAFKA_SASL_PASSWORD||""}:void 0,SSL:process.env?.KAFKA_SSL_ENABLED==="true"?{ENABLED:!0,REJECT_UNAUTHORIZED:process.env?.KAFKA_SSL_REJECT_UNAUTHORIZED!=="false",CA:process.env?.KAFKA_SSL_CA,KEY:process.env?.KAFKA_SSL_KEY,CERT:process.env?.KAFKA_SSL_CERT}:void 0},WEBSOCKET:{ENABLED:process.env?.WEBSOCKET_ENABLED==="true",GLOBAL_EVENTS:process.env?.WEBSOCKET_GLOBAL_EVENTS==="true",ALLOWED_HOSTS:process.env?.WEBSOCKET_ALLOWED_HOSTS},PUSHER:{ENABLED:process.env?.PUSHER_ENABLED==="true",GLOBAL:{ENABLED:process.env?.PUSHER_GLOBAL_ENABLED==="true",APP_ID:process.env?.PUSHER_GLOBAL_APP_ID||"",KEY:process.env?.PUSHER_GLOBAL_KEY||"",SECRET:process.env?.PUSHER_GLOBAL_SECRET||"",CLUSTER:process.env?.PUSHER_GLOBAL_CLUSTER||"",USE_TLS:process.env?.PUSHER_GLOBAL_USE_TLS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.PUSHER_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.PUSHER_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.PUSHER_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.PUSHER_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.PUSHER_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.PUSHER_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.PUSHER_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.PUSHER_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.PUSHER_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.PUSHER_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.PUSHER_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.PUSHER_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.PUSHER_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.PUSHER_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.PUSHER_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.PUSHER_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.PUSHER_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.PUSHER_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.PUSHER_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.PUSHER_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.PUSHER_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.PUSHER_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.PUSHER_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.PUSHER_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.PUSHER_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.PUSHER_EVENTS_CALL==="true",TYPEBOT_START:process.env?.PUSHER_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.PUSHER_EVENTS_TYPEBOT_CHANGE_STATUS==="true"}},WA_BUSINESS:{TOKEN_WEBHOOK:process.env.WA_BUSINESS_TOKEN_WEBHOOK||"evolution",URL:process.env.WA_BUSINESS_URL||"https://graph.facebook.com",VERSION:process.env.WA_BUSINESS_VERSION||"v18.0",LANGUAGE:process.env.WA_BUSINESS_LANGUAGE||"en"},LOG:{LEVEL:process.env?.LOG_LEVEL?.split(",")||["ERROR","WARN","DEBUG","INFO","LOG","VERBOSE","DARK","WEBHOOKS","WEBSOCKET"],COLOR:process.env?.LOG_COLOR==="true",BAILEYS:process.env?.LOG_BAILEYS||"error"},DEL_INSTANCE:(0,Y.isBooleanString)(process.env?.DEL_INSTANCE)?process.env.DEL_INSTANCE==="true":Number.parseInt(process.env.DEL_INSTANCE)||!1,DEL_TEMP_INSTANCES:(0,Y.isBooleanString)(process.env?.DEL_TEMP_INSTANCES)?process.env.DEL_TEMP_INSTANCES==="true":!0,LANGUAGE:process.env?.LANGUAGE||"en",WEBHOOK:{GLOBAL:{URL:process.env?.WEBHOOK_GLOBAL_URL||"",ENABLED:process.env?.WEBHOOK_GLOBAL_ENABLED==="true",WEBHOOK_BY_EVENTS:process.env?.WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS==="true"},EVENTS:{APPLICATION_STARTUP:process.env?.WEBHOOK_EVENTS_APPLICATION_STARTUP==="true",INSTANCE_CREATE:process.env?.WEBHOOK_EVENTS_INSTANCE_CREATE==="true",INSTANCE_DELETE:process.env?.WEBHOOK_EVENTS_INSTANCE_DELETE==="true",QRCODE_UPDATED:process.env?.WEBHOOK_EVENTS_QRCODE_UPDATED==="true",MESSAGES_SET:process.env?.WEBHOOK_EVENTS_MESSAGES_SET==="true",MESSAGES_UPSERT:process.env?.WEBHOOK_EVENTS_MESSAGES_UPSERT==="true",MESSAGES_EDITED:process.env?.WEBHOOK_EVENTS_MESSAGES_EDITED==="true",MESSAGES_UPDATE:process.env?.WEBHOOK_EVENTS_MESSAGES_UPDATE==="true",MESSAGES_DELETE:process.env?.WEBHOOK_EVENTS_MESSAGES_DELETE==="true",SEND_MESSAGE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE==="true",SEND_MESSAGE_UPDATE:process.env?.WEBHOOK_EVENTS_SEND_MESSAGE_UPDATE==="true",CONTACTS_SET:process.env?.WEBHOOK_EVENTS_CONTACTS_SET==="true",CONTACTS_UPDATE:process.env?.WEBHOOK_EVENTS_CONTACTS_UPDATE==="true",CONTACTS_UPSERT:process.env?.WEBHOOK_EVENTS_CONTACTS_UPSERT==="true",PRESENCE_UPDATE:process.env?.WEBHOOK_EVENTS_PRESENCE_UPDATE==="true",CHATS_SET:process.env?.WEBHOOK_EVENTS_CHATS_SET==="true",CHATS_UPDATE:process.env?.WEBHOOK_EVENTS_CHATS_UPDATE==="true",CHATS_UPSERT:process.env?.WEBHOOK_EVENTS_CHATS_UPSERT==="true",CHATS_DELETE:process.env?.WEBHOOK_EVENTS_CHATS_DELETE==="true",CONNECTION_UPDATE:process.env?.WEBHOOK_EVENTS_CONNECTION_UPDATE==="true",LABELS_EDIT:process.env?.WEBHOOK_EVENTS_LABELS_EDIT==="true",LABELS_ASSOCIATION:process.env?.WEBHOOK_EVENTS_LABELS_ASSOCIATION==="true",GROUPS_UPSERT:process.env?.WEBHOOK_EVENTS_GROUPS_UPSERT==="true",GROUP_UPDATE:process.env?.WEBHOOK_EVENTS_GROUPS_UPDATE==="true",GROUP_PARTICIPANTS_UPDATE:process.env?.WEBHOOK_EVENTS_GROUP_PARTICIPANTS_UPDATE==="true",CALL:process.env?.WEBHOOK_EVENTS_CALL==="true",TYPEBOT_START:process.env?.WEBHOOK_EVENTS_TYPEBOT_START==="true",TYPEBOT_CHANGE_STATUS:process.env?.WEBHOOK_EVENTS_TYPEBOT_CHANGE_STATUS==="true",ERRORS:process.env?.WEBHOOK_EVENTS_ERRORS==="true",ERRORS_WEBHOOK:process.env?.WEBHOOK_EVENTS_ERRORS_WEBHOOK||""},REQUEST:{TIMEOUT_MS:Number.parseInt(process.env?.WEBHOOK_REQUEST_TIMEOUT_MS)||3e4},RETRY:{MAX_ATTEMPTS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_ATTEMPTS)||10,INITIAL_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_INITIAL_DELAY_SECONDS)||5,USE_EXPONENTIAL_BACKOFF:process.env?.WEBHOOK_RETRY_USE_EXPONENTIAL_BACKOFF!=="false",MAX_DELAY_SECONDS:Number.parseInt(process.env?.WEBHOOK_RETRY_MAX_DELAY_SECONDS)||300,JITTER_FACTOR:Number.parseFloat(process.env?.WEBHOOK_RETRY_JITTER_FACTOR)||.2,NON_RETRYABLE_STATUS_CODES:process.env?.WEBHOOK_RETRY_NON_RETRYABLE_STATUS_CODES?.split(",").map(Number)||[400,401,403,404,422]}},CONFIG_SESSION_PHONE:{CLIENT:process.env?.CONFIG_SESSION_PHONE_CLIENT||"Evolution API",NAME:process.env?.CONFIG_SESSION_PHONE_NAME||"Chrome"},QRCODE:{LIMIT:Number.parseInt(process.env.QRCODE_LIMIT)||30,COLOR:process.env.QRCODE_COLOR||"#198754"},TYPEBOT:{ENABLED:process.env?.TYPEBOT_ENABLED==="true",API_VERSION:process.env?.TYPEBOT_API_VERSION||"old",SEND_MEDIA_BASE64:process.env?.TYPEBOT_SEND_MEDIA_BASE64==="true"},CHATWOOT:{ENABLED:process.env?.CHATWOOT_ENABLED==="true",MESSAGE_DELETE:process.env.CHATWOOT_MESSAGE_DELETE==="true",MESSAGE_READ:process.env.CHATWOOT_MESSAGE_READ==="true",BOT_CONTACT:!process.env.CHATWOOT_BOT_CONTACT||process.env.CHATWOOT_BOT_CONTACT==="true",IMPORT:{DATABASE:{CONNECTION:{URI:process.env.CHATWOOT_IMPORT_DATABASE_CONNECTION_URI||""}},PLACEHOLDER_MEDIA_MESSAGE:process.env?.CHATWOOT_IMPORT_PLACEHOLDER_MEDIA_MESSAGE==="true"}},OPENAI:{ENABLED:process.env?.OPENAI_ENABLED==="true",API_KEY_GLOBAL:process.env?.OPENAI_API_KEY_GLOBAL||null},DIFY:{ENABLED:process.env?.DIFY_ENABLED==="true"},N8N:{ENABLED:process.env?.N8N_ENABLED==="true"},EVOAI:{ENABLED:process.env?.EVOAI_ENABLED==="true"},FLOWISE:{ENABLED:process.env?.FLOWISE_ENABLED==="true"},CACHE:{REDIS:{ENABLED:process.env?.CACHE_REDIS_ENABLED==="true",URI:process.env?.CACHE_REDIS_URI||"",PREFIX_KEY:process.env?.CACHE_REDIS_PREFIX_KEY||"evolution-cache",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||604800,SAVE_INSTANCES:process.env?.CACHE_REDIS_SAVE_INSTANCES==="true"},LOCAL:{ENABLED:process.env?.CACHE_LOCAL_ENABLED==="true",TTL:Number.parseInt(process.env?.CACHE_REDIS_TTL)||86400}},S3:{ACCESS_KEY:process.env?.S3_ACCESS_KEY,SECRET_KEY:process.env?.S3_SECRET_KEY,ENDPOINT:process.env?.S3_ENDPOINT,BUCKET_NAME:process.env?.S3_BUCKET,ENABLE:process.env?.S3_ENABLED==="true",PORT:Number.parseInt(process.env?.S3_PORT||"9000"),USE_SSL:process.env?.S3_USE_SSL==="true",REGION:process.env?.S3_REGION,SKIP_POLICY:process.env?.S3_SKIP_POLICY==="true",SAVE_VIDEO:process.env?.S3_SAVE_VIDEO==="true"},AUTHENTICATION:{API_KEY:{KEY:process.env.AUTHENTICATION_API_KEY||"BQYHJGJHJ"},EXPOSE_IN_FETCH_INSTANCES:process.env?.AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES==="true"},METRICS:{ENABLED:process.env?.PROMETHEUS_METRICS==="true",AUTH_REQUIRED:process.env?.METRICS_AUTH_REQUIRED==="true",USER:process.env?.METRICS_USER,PASSWORD:process.env?.METRICS_PASSWORD,ALLOWED_IPS:process.env?.METRICS_ALLOWED_IPS},TELEMETRY:{ENABLED:process.env?.TELEMETRY_ENABLED===void 0||process.env?.TELEMETRY_ENABLED==="true",URL:process.env?.TELEMETRY_URL},PROXY:{HOST:process.env?.PROXY_HOST,PORT:process.env?.PROXY_PORT,PROTOCOL:process.env?.PROXY_PROTOCOL,USERNAME:process.env?.PROXY_USERNAME,PASSWORD:process.env?.PROXY_PASSWORD},AUDIO_CONVERTER:{API_URL:process.env?.API_AUDIO_CONVERTER,API_KEY:process.env?.API_AUDIO_CONVERTER_KEY},FACEBOOK:{APP_ID:process.env?.FACEBOOK_APP_ID,CONFIG_ID:process.env?.FACEBOOK_CONFIG_ID,USER_TOKEN:process.env?.FACEBOOK_USER_TOKEN},SENTRY:{DSN:process.env?.SENTRY_DSN},EVENT_EMITTER:{MAX_LISTENERS:Number.parseInt(process.env?.EVENT_EMITTER_MAX_LISTENERS)||50}}}},v=new G;var ie=D(require("dayjs")),Ee=D(require("fs"));var Re=JSON.parse(Ee.default.readFileSync("./package.json","utf8")),re=C=>(0,ie.default)(C).toDate().toString().replace(/\sGMT.+/,""),b=(n=>(n.LOG="\x1B[32m",n.INFO="\x1B[34m",n.WARN="\x1B[33m",n.ERROR="\x1B[31m",n.DEBUG="\x1B[36m",n.VERBOSE="\x1B[37m",n.DARK="\x1B[30m",n))(b||{});var ce=(n=>(n.LOG="\x1B[32m%s\x1B[0m",n.DARK="\x1B[30m%s\x1B[0m",n.INFO="\x1B[34m%s\x1B[0m",n.WARN="\x1B[33m%s\x1B[0m",n.ERROR="\x1B[31m%s\x1B[0m",n.DEBUG="\x1B[36m%s\x1B[0m",n.VERBOSE="\x1B[37m%s\x1B[0m",n))(ce||{}),Se=(n=>(n.LOG="LOG",n.WARN="WARN",n.INFO="INFO",n.DARK="DARK",n.ERROR="ERROR",n.DEBUG="DEBUG",n.VERBOSE="VERBOSE",n))(Se||{}),_e=(n=>(n.LOG="\x1B[42m",n.INFO="\x1B[44m",n.WARN="\x1B[43m",n.DARK="\x1B[40m",n.ERROR="\x1B[41m",n.DEBUG="\x1B[46m",n.VERBOSE="\x1B[47m",n))(_e||{}),w=class{constructor(e="Logger"){this.configService=v;this.instance=null;this.context=e}setContext(e){this.context=e}setInstance(e){this.instance=e}console(e,t){let s=[];this.configService.get("LOG").LEVEL.forEach(i=>s.push(Se[i]));let a=typeof e;s.includes(t)&&(v.get("LOG").COLOR?(console.log("\x1B[1m"+ce[t],"[Evolution API]","\x1B[1m"+b[t],this.instance?`[${this.instance}]`:"","\x1B[1m"+b[t],`v${Re.version}`,"\x1B[1m"+b[t],process.pid.toString(),"\x1B[0m","\x1B[1m"+b[t],"-","\x1B[1m\x1B[37m",`${re(Date.now())}  `,"\x1B[0m",b[t]+_e[t]+"\x1B[1m",`${t} \x1B[0m`,"\x1B[33m\x1B[1m",`[${this.context}]\x1B[0m`,b[t]+"\x1B[1m",`[${a}]\x1B[0m`,b[t],a!=="object"?e:"","\x1B[0m"),a==="object"&&console.log(e,`
`)):console.log("[Evolution API]",this.instance?`[${this.instance}]`:"",process.pid.toString(),"-",`${re(Date.now())}  `,`${t} `,`[${this.context}]`,`[${a}]`,e))}log(e){this.console(e,"LOG")}info(e){this.console(e,"INFO")}warn(e){this.console(e,"WARN")}error(e){this.console(e,"ERROR")}verbose(e){this.console(e,"VERBOSE")}debug(e){this.console(e,"DEBUG")}dark(e){this.console(e,"DARK")}};var Te=D(require("pg")),{Pool:De}=Te.default,Q=class{constructor(){this.logger=new w("Postgres");this.connected=!1}getConnection(e){if(this.connected)return this.pool;this.pool=new De({connectionString:e,ssl:{rejectUnauthorized:!1}}),this.pool.on("error",()=>{this.logger.error("postgres disconnected"),this.connected=!1});try{this.connected=!0}catch(t){return this.connected=!1,this.logger.error("postgres connect exception caught: "+t),null}return this.pool}getChatwootConnection(){let e=v.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return this.getConnection(e)}},M=new Q;var q=class{constructor(){this.logger=new w("ChatwootImport");this.repositoryMessagesCache=new Map;this.historyMessages=new Map;this.historyContacts=new Map}getRepositoryMessagesCache(e){return this.repositoryMessagesCache.has(e.instanceName)?this.repositoryMessagesCache.get(e.instanceName):null}setRepositoryMessagesCache(e,t){this.repositoryMessagesCache.set(e.instanceName,t)}deleteRepositoryMessagesCache(e){this.repositoryMessagesCache.delete(e.instanceName)}addHistoryMessages(e,t){let s=this.historyMessages.has(e.instanceName)?this.historyMessages.get(e.instanceName):[];this.historyMessages.set(e.instanceName,[...s,...t])}addHistoryContacts(e,t){let s=this.historyContacts.has(e.instanceName)?this.historyContacts.get(e.instanceName):[];this.historyContacts.set(e.instanceName,s.concat(t))}deleteHistoryMessages(e){this.historyMessages.delete(e.instanceName)}deleteHistoryContacts(e){this.historyContacts.delete(e.instanceName)}clearAll(e){this.deleteRepositoryMessagesCache(e),this.deleteHistoryMessages(e),this.deleteHistoryContacts(e)}getHistoryMessagesLenght(e){return this.historyMessages.get(e.instanceName)?.length??0}async importHistoryContacts(e,t){try{if(this.getHistoryMessagesLenght(e)>0)return;let s=M.getChatwootConnection(),a=0,i=this.historyContacts.get(e.instanceName)||[];if(i.length===0)return 0;let o=this.sliceIntoChunks(i,3e3);for(;o.length>0;){let n=`SELECT id FROM labels WHERE title = '${t.nameInbox}' AND account_id = ${t.accountId} LIMIT 1`,r=(await s.query(n))?.rows[0]?.id;if(!r){let I=`INSERT INTO labels (title, color, show_on_sidebar, account_id, created_at, updated_at) VALUES ('${t.nameInbox}', '#34039B', true, ${t.accountId}, NOW(), NOW()) RETURNING id`;r=(await s.query(I))?.rows[0]?.id}let E=`INSERT INTO contacts
          (name, phone_number, account_id, identifier, created_at, updated_at) VALUES `,S=[t.accountId];for(let I of o){let d=this.isIgnorePhoneNumber(I.remoteJid),l=d?`${I.pushName} (GROUP)`:I.pushName;S.push(l);let R=`$${S.length}`,h;d?h="NULL":(S.push(`+${I.remoteJid.split("@")[0]}`),h=`$${S.length}`),S.push(I.remoteJid);let p=`$${S.length}`;E+=`(${R}, ${h}, $1, ${p}, NOW(), NOW()),`}E.slice(-1)===","&&(E=E.slice(0,-1)),E+=` ON CONFLICT (identifier, account_id)
                       DO UPDATE SET
                        name = EXCLUDED.name,
                        phone_number = EXCLUDED.phone_number,
                        updated_at = NOW()`,a+=(await s.query(E,S))?.rowCount??0;let c=`SELECT id FROM tags WHERE name = '${t.nameInbox}' LIMIT 1`,T=(await s.query(c))?.rows[0]?.id,g=`INSERT INTO tags (name, taggings_count) VALUES ('${t.nameInbox}', ${a}) ON CONFLICT (name) DO UPDATE SET taggings_count = tags.taggings_count + ${a} RETURNING id`;T=(await s.query(g))?.rows[0]?.id,await s.query(g);let A="INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) VALUES ";o.forEach(I=>{let d=`(SELECT id FROM contacts WHERE identifier = '${I.remoteJid}' AND account_id = ${t.accountId})`;A+=`($1, $2, ${d}, $3, NOW()),`}),A.slice(-1)===","&&(A=A.slice(0,-1)),await s.query(A,[T,"Contact","labels"]),o=this.sliceIntoChunks(i,3e3)}return this.deleteHistoryContacts(e),a}catch(s){this.logger.error(`Error on import history contacts: ${s.toString()}`)}}async getExistingSourceIds(e,t){try{let s=new Set;if(e.length===0)return s;let a=e.map(E=>`WAID:${E.replace("WAID:","")}`),i=M.getChatwootConnection(),o=t?[a,t]:[a],n=t?"SELECT source_id FROM messages WHERE source_id = ANY($1) AND conversation_id = $2":"SELECT source_id FROM messages WHERE source_id = ANY($1)",r=await i.query(n,o);for(let E of r.rows)s.add(E.source_id);return s}catch(s){return this.logger.error(`Error on getExistingSourceIds: ${s.toString()}`),new Set}}async importHistoryMessages(e,t,s,a){try{let i=M.getChatwootConnection(),o=await this.getChatwootUser(a);if(!o)throw new Error("User not found to import messages.");let n=0,r=this.historyMessages.get(e.instanceName)||[];if(r.length===0)return 0;r.sort((A,I)=>{let d=A.key,l=I.key,R=A.messageTimestamp,h=I.messageTimestamp;return parseInt(d.remoteJid)-parseInt(l.remoteJid)||R-h});let E=this.createMessagesMapByPhoneNumber(r),S=new Map;E.forEach((A,I)=>{S.set(I,{first:A[0]?.messageTimestamp,last:A[A.length-1]?.messageTimestamp})});let c=await this.getExistingSourceIds(r.map(A=>A.key.id));r=r.filter(A=>!c.has(A.key.id));let _=4e3,T=this.sliceIntoChunks(r,_);for(;T.length>0;){let A=this.createMessagesMapByPhoneNumber(T);if(A.size>0){let I=await this.selectOrCreateFksFromChatwoot(a,s,S,A),d=`INSERT INTO messages
            (content, processed_message_content, account_id, inbox_id, conversation_id, message_type, private, content_type,
            sender_type, sender_id, source_id, created_at, updated_at) VALUES `,l=[a.accountId,s.id];A.forEach((R,h)=>{let p=I.get(h);R.forEach(m=>{if(!m.message||!p?.conversation_id||!p?.contact_id)return;let N=this.getContentMessage(t,m);if(!N)return;l.push(N);let O=`$${l.length}`;l.push(p.conversation_id);let P=`$${l.length}`;l.push(m.key.fromMe?"1":"0");let L=`$${l.length}`;l.push(m.key.fromMe?o.user_type:"Contact");let B=`$${l.length}`;l.push(m.key.fromMe?o.user_id:p.contact_id);let k=`$${l.length}`;l.push("WAID:"+m.key.id);let V=`$${l.length}`;l.push(m.messageTimestamp);let U=`$${l.length}`;d+=`(${O}, ${O}, $1, $2, ${P}, ${L}, FALSE, 0,
                  ${B},${k},${V}, to_timestamp(${U}), to_timestamp(${U})),`})}),l.length>2&&(d.slice(-1)===","&&(d=d.slice(0,-1)),n+=(await i.query(d,l))?.rowCount??0)}T=this.sliceIntoChunks(r,_)}this.deleteHistoryMessages(e),this.deleteRepositoryMessagesCache(e);let g={...a,ignoreJids:Array.isArray(a.ignoreJids)?a.ignoreJids.map(A=>String(A)):[]};return this.importHistoryContacts(e,g),n}catch(i){this.logger.error(`Error on import history messages: ${i.toString()}`),this.deleteHistoryMessages(e),this.deleteRepositoryMessagesCache(e)}}async selectOrCreateFksFromChatwoot(e,t,s,a){let i=M.getChatwootConnection(),o=[e.accountId,t.id],r=`WITH
              phone_number AS (
                SELECT phone_number, created_at::INTEGER, last_activity_at::INTEGER FROM (
                  VALUES 
                   ${Array.from(a.keys()).map(S=>{let c=s.get(S);if(c){o.push(S);let _=`($${o.length},`;return o.push(c.first),_+=`$${o.length},`,o.push(c.last),`${_}$${o.length})`}}).join(",")}
                 ) as t (phone_number, created_at, last_activity_at)
              ),

              only_new_phone_number AS (
                SELECT * FROM phone_number
                WHERE phone_number NOT IN (
                  SELECT phone_number
                  FROM contacts
                    JOIN contact_inboxes ci ON ci.contact_id = contacts.id AND ci.inbox_id = $2
                    JOIN conversations con ON con.contact_inbox_id = ci.id 
                      AND con.account_id = $1
                      AND con.inbox_id = $2
                      AND con.contact_id = contacts.id
                  WHERE contacts.account_id = $1
                )
              ),

              new_contact AS (
                INSERT INTO contacts (name, phone_number, account_id, identifier, created_at, updated_at)
                SELECT REPLACE(p.phone_number, '+', ''), p.phone_number, $1, CONCAT(REPLACE(p.phone_number, '+', ''),
                  '@s.whatsapp.net'), to_timestamp(p.created_at), to_timestamp(p.last_activity_at)
                FROM only_new_phone_number AS p
                ON CONFLICT(identifier, account_id) DO UPDATE SET updated_at = EXCLUDED.updated_at
                RETURNING id, phone_number, created_at, updated_at
              ),

              new_contact_inbox AS (
                INSERT INTO contact_inboxes (contact_id, inbox_id, source_id, created_at, updated_at)
                SELECT new_contact.id, $2, gen_random_uuid(), new_contact.created_at, new_contact.updated_at
                FROM new_contact 
                RETURNING id, contact_id, created_at, updated_at
              ),

              new_conversation AS (
                INSERT INTO conversations (account_id, inbox_id, status, contact_id,
                  contact_inbox_id, uuid, last_activity_at, created_at, updated_at)
                SELECT $1, $2, 0, new_contact_inbox.contact_id, new_contact_inbox.id, gen_random_uuid(),
                  new_contact_inbox.updated_at, new_contact_inbox.created_at, new_contact_inbox.updated_at
                FROM new_contact_inbox
                RETURNING id, contact_id
              )

              SELECT new_contact.phone_number, new_conversation.contact_id, new_conversation.id AS conversation_id
              FROM new_conversation 
              JOIN new_contact ON new_conversation.contact_id = new_contact.id

              UNION

              SELECT p.phone_number, c.id contact_id, con.id conversation_id
                FROM phone_number p
              JOIN contacts c ON c.phone_number = p.phone_number
              JOIN contact_inboxes ci ON ci.contact_id = c.id AND ci.inbox_id = $2
              JOIN conversations con ON con.contact_inbox_id = ci.id AND con.account_id = $1
                AND con.inbox_id = $2 AND con.contact_id = c.id`,E=await i.query(r,o);return new Map(E.rows.map(S=>[S.phone_number,S]))}async getChatwootUser(e){try{return(await M.getChatwootConnection().query(`SELECT owner_type AS user_type, owner_id AS user_id
                         FROM access_tokens
                       WHERE token = $1`,[e.token]))?.rows[0]||!1}catch(t){this.logger.error(`Error on getChatwootUser: ${t.toString()}`)}}createMessagesMapByPhoneNumber(e){return e.reduce((t,s)=>{let a=s?.key;if(!this.isIgnorePhoneNumber(a?.remoteJid)){let i=a?.remoteJid?.split("@")[0];if(i){let o=`+${i}`,n=t.has(o)?t.get(o):[];n.push(s),t.set(o,n)}}return t},new Map)}async getContactsOrderByRecentConversations(e,t,s=50){try{return(await M.getChatwootConnection().query(`SELECT contacts.id, contacts.identifier, contacts.phone_number
                     FROM conversations
                   JOIN contacts ON contacts.id = conversations.contact_id
                   WHERE conversations.account_id = $1
                     AND inbox_id = $2
                   ORDER BY conversations.last_activity_at DESC
                   LIMIT $3`,[t.accountId,e.id,s]))?.rows}catch(a){this.logger.error(`Error on get recent conversations: ${a.toString()}`)}}getContentMessage(e,t){let s=e.getConversationMessage(t.message);if(s)return s;if(!v.get("CHATWOOT").IMPORT.PLACEHOLDER_MEDIA_MESSAGE)return"";let a={documentMessage:t.message.documentMessage,documentWithCaptionMessage:t.message.documentWithCaptionMessage?.message?.documentMessage,imageMessage:t.message.imageMessage,videoMessage:t.message.videoMessage,audioMessage:t.message.audioMessage,stickerMessage:t.message.stickerMessage,templateMessage:t.message.templateMessage?.hydratedTemplate?.hydratedContentText};switch(Object.keys(a).find(o=>a[o]!==void 0&&a[o]!==null)){case"documentMessage":{let o=t.message.documentMessage,n=o?.fileName||"document",r=o?.caption?` ${o.caption}`:"";return`_<File: ${n}${r}>_`}case"documentWithCaptionMessage":{let o=t.message.documentWithCaptionMessage?.message?.documentMessage,n=o?.fileName||"document",r=o?.caption?` ${o.caption}`:"";return`_<File: ${n}${r}>_`}case"templateMessage":{let o=t.message.templateMessage?.hydratedTemplate;return(o?.hydratedTitleText?`*${o.hydratedTitleText}*
`:"")+(o?.hydratedContentText||"")}case"imageMessage":return"_<Image Message>_";case"videoMessage":return"_<Video Message>_";case"audioMessage":return"_<Audio Message>_";case"stickerMessage":return"_<Sticker Message>_";default:return""}}sliceIntoChunks(e,t){return e.splice(0,t)}isGroup(e){return e.includes("@g.us")}isIgnorePhoneNumber(e){return this.isGroup(e)||e==="status@broadcast"||e==="0@s.whatsapp.net"}updateMessageSourceID(e,t){return M.getChatwootConnection().query("UPDATE messages SET source_id = $1, status = 0, created_at = NOW(), updated_at = NOW() WHERE id = $2;",[`WAID:${t}`,e])}},f=new q;var pe=D(require("@figuro/chatwoot-sdk")),H=require("@figuro/chatwoot-sdk/dist/core/request");var J=D(require("fs")),X=D(require("i18next")),z=D(require("path")),fe=["en","pt-BR","es"],Pe=z.default.join(__dirname,"translations"),Me=new G,Ae={};fe.forEach(C=>{let e=z.default.join(Pe,`${C}.json`);if(J.default.existsSync(e)){let t=J.default.readFileSync(e,"utf8");Ae[C]={translation:JSON.parse(t)}}});X.default.init({resources:Ae,fallbackLng:"en",lng:Me.get("LANGUAGE"),debug:!1,interpolation:{escapeValue:!1}});var u=X.default;var le=D(require("axios")),ge=D(require("fs")),ve=JSON.parse(ge.default.readFileSync("./package.json","utf8")),x=async C=>{let e=v.get("TELEMETRY");if(!e.ENABLED||C==="/")return;let t={route:C,apiVersion:`${ve.version}`,timestamp:new Date},s=e.URL&&e.URL!==""?e.URL:"https://log.evolution-api.com/telemetry";le.default.post(s,t).then(()=>{}).catch(()=>{})};var $=D(require("axios")),ue=D(require("dayjs")),j=D(require("form-data")),F=require("jimp"),Z=require("libphonenumber-js"),ee=D(require("long")),y=D(require("mime-types")),te=D(require("path")),W=require("stream"),se=class{constructor(e,t,s,a){this.waMonitor=e;this.configService=t;this.prismaRepository=s;this.cache=a;this.logger=new w("ChatwootService");this.LOCK_POLLING_DELAY_MS=300;this.pgClient=M.getChatwootConnection()}async getProvider(e){let t=`${e.instanceName}:getProvider`;if(await this.cache.has(t))return await this.cache.get(t);let s=await this.waMonitor.waInstances[e.instanceName]?.findChatwoot();return s?(this.cache.set(t,s),s):(this.logger.warn("provider not found"),null)}async clientCw(e){let t=await this.getProvider(e);return t?(this.provider=t,new pe.default({config:this.getClientCwConfig()})):(this.logger.error("provider not found"),null)}getClientCwConfig(){return{basePath:this.provider.url,with_credentials:!0,credentials:"include",token:this.provider.token,nameInbox:this.provider.nameInbox,mergeBrazilContacts:this.provider.mergeBrazilContacts}}getCache(){return this.cache}async create(e,t){if(await this.waMonitor.waInstances[e.instanceName].setChatwoot(t),t.autoCreate){this.logger.log("Auto create chatwoot instance");let s=this.configService.get("SERVER").URL;await this.initInstanceChatwoot(e,t.nameInbox??e.instanceName.split("-cwId-")[0],`${s}/chatwoot/webhook/${encodeURIComponent(e.instanceName)}`,!0,t.number,t.organization,t.logo)}return t}async find(e){try{return await this.waMonitor.waInstances[e.instanceName].findChatwoot()}catch{return this.logger.error("chatwoot not found"),{enabled:null,url:""}}}async getContact(e,t){let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;if(!t)return this.logger.warn("id is required"),null;let a=await s.contact.getContactable({accountId:this.provider.accountId,id:t});return a||(this.logger.warn("contact not found"),null)}async initInstanceChatwoot(e,t,s,a,i,o,n){let r=await this.clientCw(e);if(!r)return this.logger.warn("client not found"),null;let E=await r.inboxes.list({accountId:this.provider.accountId}),S=E.payload.map(g=>g.name).includes(t),c;if(this.logger.log("Creating chatwoot inbox"),S){let g=E.payload.find(A=>A.name===t);if(!g)return this.logger.warn("inbox not found"),null;c=g.id}else{let g={type:"api",webhook_url:s},A=await r.inboxes.create({accountId:this.provider.accountId,data:{name:t,channel:g}});if(!A)return this.logger.warn("inbox not found"),null;c=A.id}if(this.logger.log(`Inbox created - inboxId: ${c}`),!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;this.logger.log("Creating chatwoot bot contact");let _=await this.findContact(e,"123456")||await this.createContact(e,"123456",c,!1,o||"EvolutionAPI",n||"https://evolution-api.com/files/evolution-api-favicon.png");if(!_)return this.logger.warn("contact not found"),null;let T=_.id||_.payload.contact.id;if(this.logger.log(`Contact created - contactId: ${T}`),a){this.logger.log("QR code enabled");let g={contact_id:T.toString(),inbox_id:c.toString()},A=await r.conversations.create({accountId:this.provider.accountId,data:g});if(!A)return this.logger.warn("conversation not found"),null;let I="init";if(i&&(I=`init:${i}`),!await r.messages.create({accountId:this.provider.accountId,conversationId:A.id,data:{content:I,message_type:"outgoing"}}))return this.logger.warn("conversation not found"),null;this.logger.log("Init message sent")}return!0}async createContact(e,t,s,a,i,o,n){try{let r=await this.clientCw(e);if(!r)return this.logger.warn("client not found"),null;let E={};a?E={inbox_id:s,name:i||t,identifier:t,avatar_url:o}:(E={inbox_id:s,name:i||t,identifier:n,avatar_url:o},(n&&n.includes("@")||!n)&&(E.phone_number=`+${t}`));let S=await r.contacts.create({accountId:this.provider.accountId,data:E});if(!S)return this.logger.warn("contact not found"),null;let _=(await this.findContact(e,t))?.id;return await this.addLabelToContact(this.provider.nameInbox,_),S}catch(r){if((r.status===422||r.response?.status===422)&&n){this.logger.warn(`Contact with identifier ${n} creation failed (422). Checking if it already exists...`);let E=await this.findContactByIdentifier(e,n);if(E){let S=E.id;return await this.addLabelToContact(this.provider.nameInbox,S),E}}return this.logger.error("Error creating contact"),console.log(r),null}}async updateContact(e,t,s){let a=await this.clientCw(e);if(!a)return this.logger.warn("client not found"),null;if(!t)return this.logger.warn("id is required"),null;try{return await a.contacts.update({accountId:this.provider.accountId,id:t,data:s})}catch{return null}}async addLabelToContact(e,t){try{if(!this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI)return!1;let i=(await this.pgClient.query("SELECT id, taggings_count FROM tags WHERE name = $1 LIMIT 1",[e]))?.rows[0],o=i?.id,n=i?.taggings_count||0;return o=(await this.pgClient.query(`INSERT INTO tags (name, taggings_count) 
                      VALUES ($1, $2) 
                      ON CONFLICT (name) 
                      DO UPDATE SET taggings_count = tags.taggings_count + 1 
                      RETURNING id`,[e,n+1]))?.rows[0]?.id,(await this.pgClient.query(`SELECT 1 FROM taggings 
                               WHERE tag_id = $1 AND taggable_type = 'Contact' AND taggable_id = $2 AND context = 'labels' LIMIT 1`,[o,t]))?.rowCount>0||await this.pgClient.query(`INSERT INTO taggings (tag_id, taggable_type, taggable_id, context, created_at) 
                                VALUES ($1, 'Contact', $2, 'labels', NOW())`,[o,t]),!0}catch{return!1}}async findContactByIdentifier(e,t){let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let a=await s.get("contacts/search",{params:{q:t,sort:"name"}});if(a&&a.data&&a.data.payload&&a.data.payload.length>0)return a.data.payload[0];if(a&&a.payload&&a.payload.length>0)return a.payload[0];let i=await s.post("contacts/filter",{payload:[{attribute_key:"identifier",filter_operator:"equal_to",values:[t],query_operator:null}]});return i&&i.payload&&i.payload.length>0?i.payload[0]:i&&i.data&&i.data.payload&&i.data.payload.length>0?i.data.payload[0]:null}async findContact(e,t){let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let a,i=t.includes("@g.us");i?a=t:a=`+${t}`;let o;return i?o=await s.contacts.search({accountId:this.provider.accountId,q:a}):o=await(0,H.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/contacts/filter`,body:{payload:this.getFilterPayload(a)}}),!o&&o?.payload?.length===0?(this.logger.warn("contact not found"),null):i?o.payload.find(n=>n.identifier===a):o.payload.length>1?this.findContactInContactList(o.payload,a):o.payload[0]}async mergeContacts(e,t){try{return await(0,H.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,body:{base_contact_id:e,mergee_contact_id:t}})}catch{return this.logger.error("Error merging contacts"),null}}async mergeBrazilianContacts(e){try{return await(0,H.request)(this.getClientCwConfig(),{method:"POST",url:`/api/v1/accounts/${this.provider.accountId}/actions/contact_merge`,body:{base_contact_id:e.find(s=>s.phone_number.length===14)?.id,mergee_contact_id:e.find(s=>s.phone_number.length===13)?.id}})}catch{return this.logger.error("Error merging contacts"),null}}findContactInContactList(e,t){let s=this.getNumbers(t),a=this.getSearchableFields();if(e.length===2&&this.getClientCwConfig().mergeBrazilContacts&&t.startsWith("+55")){let n=this.mergeBrazilianContacts(e);if(n)return n}let i=s.reduce((n,r)=>r.length>n.length?r:n,""),o=e.find(n=>n.phone_number===i);if(o)return o;for(let n of e)for(let r of a)if(n[r]&&s.includes(n[r]))return n;return null}getNumbers(e){let t=[];if(t.push(e),e.startsWith("+55")&&e.length===14){let s=e.slice(0,5)+e.slice(6);t.push(s)}else if(e.startsWith("+55")&&e.length===13){let s=e.slice(0,5)+"9"+e.slice(5);t.push(s)}return t}getSearchableFields(){return["phone_number"]}getFilterPayload(e){let t=[],s=this.getNumbers(e),a=this.getSearchableFields();return a.forEach((i,o)=>{s.forEach((n,r)=>{let E=a.length-1===o&&s.length-1===r?null:"OR";t.push({attribute_key:i,filter_operator:"equal_to",values:[n.replace("+","")],query_operator:E})})}),t}async createConversation(e,t){let s=t.key.addressingMode==="lid",a=t.key.remoteJid.endsWith("@g.us"),i=s&&!a?t.key.remoteJidAlt:t.key.remoteJid,{remoteJid:o}=t.key,n=`${e.instanceName}:createConversation-${o}`,r=`${e.instanceName}:lock:createConversation-${o}`,E=5e3,S=await this.clientCw(e);if(!S)return null;try{if(i&&o&&!a){let c=await this.findContact(e,i.split("@")[0]);if(c&&c.identifier!==o&&(this.logger.verbose(`Identifier needs update: (contact.identifier: ${c.identifier}, phoneNumber: ${i}, body.key.remoteJidAlt: ${o}`),await this.updateContact(e,c.id,{identifier:i,phone_number:`+${i.split("@")[0]}`})===null)){let T=await this.findContact(e,i.split("@")[0]);T&&(await this.mergeContacts(T.id,c.id),this.logger.verbose(`Merge contacts: (${T.id}) ${T.phone_number} and (${c.id}) ${c.phone_number}`))}}if(this.logger.verbose("--- Start createConversation ---"),this.logger.verbose(`Instance: ${JSON.stringify(e)}`),await this.cache.has(n)){let c=await this.cache.get(n);this.logger.verbose(`Found conversation to: ${i}, conversation ID: ${c}`);let _;try{_=await S.conversations.get({accountId:this.provider.accountId,conversationId:c}),this.logger.verbose(`Conversation exists: ID: ${_.id} - Name: ${_.meta.sender.name} - Identifier: ${_.meta.sender.identifier}`)}catch(T){this.logger.error(`Error getting conversation: ${T}`),_=!1}return _?c:(this.logger.verbose("Conversation does not exist, re-calling createConversation"),this.cache.delete(n),await this.createConversation(e,t))}if(await this.cache.has(r)){this.logger.verbose(`Opera\xE7\xE3o de cria\xE7\xE3o j\xE1 em andamento para ${o}, aguardando resultado...`);let c=Date.now();for(;await this.cache.has(r);){if(Date.now()-c>E){this.logger.warn(`Timeout aguardando lock para ${o}`);break}if(await new Promise(_=>setTimeout(_,this.LOCK_POLLING_DELAY_MS)),await this.cache.has(n)){let _=await this.cache.get(n);return this.logger.verbose(`Resolves creation of: ${o}, conversation ID: ${_}`),_}}}await this.cache.set(r,!0,30),this.logger.verbose(`Bloqueio adquirido para: ${r}`);try{if(await this.cache.has(n))return await this.cache.get(n);let c=a?o:i.split("@")[0].split(":")[0],_=t.key.fromMe?c:t.pushName,T=await this.getInbox(e);if(!T)return null;if(a){this.logger.verbose("Processing group conversation");let p=await this.waMonitor.waInstances[e.instanceName].client.groupMetadata(c);this.logger.verbose(`Group metadata: JID:${p.JID} - Subject:${p?.subject||p?.Name}`);let m=s&&!t.key.fromMe?t.key.participantAlt:t.key.participant;_=`${p.subject} (GROUP)`;let N=await this.waMonitor.waInstances[e.instanceName].profilePicture(m.split("@")[0]);this.logger.verbose(`Participant profile picture URL: ${JSON.stringify(N)}`);let O=await this.findContact(e,m.split("@")[0]);O?(this.logger.verbose(`Found participant: ID:${O.id} - Name: ${O.name} - identifier: ${O.identifier}`),(!O.name||O.name===c)&&await this.updateContact(e,O.id,{name:t.pushName,avatar_url:N.profilePictureUrl||null})):await this.createContact(e,m.split("@")[0].split(":")[0],T.id,!1,t.pushName,N.profilePictureUrl||null,m)}let g=await this.waMonitor.waInstances[e.instanceName].profilePicture(c);this.logger.verbose(`Contact profile picture URL: ${JSON.stringify(g)}`),this.logger.verbose(`Searching contact for: ${c}`);let A=await this.findContact(e,c);if(A){if(this.logger.verbose(`Found contact: ID:${A.id} - Name:${A.name}`),!t.key.fromMe){let p=g?.profilePictureUrl?.split("#")[0].split("?")[0].split("/").pop()||"",m=A?.thumbnail?.split("#")[0].split("?")[0].split("/").pop()||"",N=p!==m,O=!A.name||A.name===c;this.logger.verbose(`Picture needs update: ${N}`),this.logger.verbose(`Name needs update: ${O}`),(N||O)&&(A=await this.updateContact(e,A.id,{...O&&{name:_},...p===""&&{avatar:null},...N&&{avatar_url:g?.profilePictureUrl}}))}}else A=await this.createContact(e,c,T.id,a,_,g.profilePictureUrl||null,i);if(!A)return this.logger.warn("Contact not created or found"),null;let I=A?.payload?.id||A?.payload?.contact?.id||A?.id;this.logger.verbose(`Contact ID: ${I}`);let d=await S.contacts.listConversations({accountId:this.provider.accountId,id:I});if(!d||!d.payload)return this.logger.error("No conversations found or payload is undefined"),null;let l=d.payload.find(p=>p.inbox_id==T.id);if(l&&(this.provider.reopenConversation?(this.logger.verbose(`Found conversation in reopenConversation mode: ID: ${l.id} - Name: ${l.meta.sender.name} - Identifier: ${l.meta.sender.identifier}`),l&&this.provider.conversationPending&&l.status!=="open"&&await S.conversations.toggleStatus({accountId:this.provider.accountId,conversationId:l.id,data:{status:"pending"}})):(l=d.payload.find(p=>p&&p.status!=="resolved"&&p.inbox_id==T.id),this.logger.verbose(`Found conversation: ${JSON.stringify(l)}`)),l))return this.logger.verbose(`Returning existing conversation ID: ${l.id}`),this.cache.set(n,l.id,1800),l.id;let R={contact_id:I.toString(),inbox_id:T.id.toString()};this.provider.conversationPending&&(R.status="pending");let h=await S.conversations.create({accountId:this.provider.accountId,data:R});return h?(this.logger.verbose(`New conversation created of ${o} with ID: ${h.id}`),this.cache.set(n,h.id,1800),h.id):(this.logger.warn("Conversation not created or found"),null)}finally{await this.cache.delete(r),this.logger.verbose(`Block released for: ${r}`)}}catch(c){return this.logger.error(`Error in createConversation: ${c}`),null}}async getInbox(e){let t=`${e.instanceName}:getInbox`;if(await this.cache.has(t))return await this.cache.get(t);let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let a=await s.inboxes.list({accountId:this.provider.accountId});if(!a)return this.logger.warn("inbox not found"),null;let i=a.payload.find(o=>o.name===this.getClientCwConfig().nameInbox);return i?(this.cache.set(t,i),i):(this.logger.warn("inbox not found"),null)}async createMessage(e,t,s,a,i,o,n,r,E){let S=await this.clientCw(e);if(!S)return this.logger.warn("client not found"),null;let c=await this.getReplyToIds(n,e),_=E?.chatwootMessageId||null,T=await S.messages.create({accountId:this.provider.accountId,conversationId:t,data:{content:s,message_type:a,attachments:o,private:i||!1,source_id:r,content_attributes:{...c},source_reply_id:_?_.toString():null}});return T||(this.logger.warn("message not found"),null)}async getOpenConversationByContact(e,t,s){let a=await this.clientCw(e);return a?(await a.contacts.listConversations({accountId:this.provider.accountId,id:s.id})).payload.find(o=>o.inbox_id===t.id&&o.status==="open")||void 0:(this.logger.warn("client not found"),null)}async createBotMessage(e,t,s,a){let i=await this.clientCw(e);if(!i)return this.logger.warn("client not found"),null;let o=await this.findContact(e,"123456");if(!o)return this.logger.warn("contact not found"),null;let n=await this.getInbox(e);if(!n)return this.logger.warn("inbox not found"),null;let r=await this.getOpenConversationByContact(e,n,o);if(!r){this.logger.warn("conversation not found");return}let E=await i.messages.create({accountId:this.provider.accountId,conversationId:r.id,data:{content:t,message_type:s,attachments:a}});return E||(this.logger.warn("message not found"),null)}async sendData(e,t,s,a,i,o,n,r,E){if(r&&this.isImportHistoryAvailable()){let T=await f.getExistingSourceIds([r],e);if(T&&T.size>0)return this.logger.warn("Message already saved on chatwoot"),null}let S=new j.default;i&&S.append("content",i),S.append("message_type",a),S.append("attachments[]",t,{filename:s});let c=E?.chatwootMessageId||null;if(n&&o){let T=await this.getReplyToIds(n,o);if(T.in_reply_to||T.in_reply_to_external_id){let g=JSON.stringify({...T});S.append("content_attributes",g)}}c&&S.append("source_reply_id",c.toString()),r&&S.append("source_id",r);let _={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${e}/messages`,headers:{api_access_token:this.provider.token,...S.getHeaders()},data:S};try{let{data:T}=await $.default.request(_);return T}catch(T){this.logger.error(T)}}async createBotQr(e,t,s,a,i){if(!await this.clientCw(e))return this.logger.warn("client not found"),null;if(!this.configService.get("CHATWOOT").BOT_CONTACT)return this.logger.log("Chatwoot bot contact is disabled"),!0;let n=await this.findContact(e,"123456");if(!n)return this.logger.warn("contact not found"),null;let r=await this.getInbox(e);if(!r)return this.logger.warn("inbox not found"),null;let E=await this.getOpenConversationByContact(e,r,n);if(!E){this.logger.warn("conversation not found");return}let S=new j.default;t&&S.append("content",t),S.append("message_type",s),a&&i&&S.append("attachments[]",a,{filename:i});let c={method:"post",maxBodyLength:1/0,url:`${this.provider.url}/api/v1/accounts/${this.provider.accountId}/conversations/${E.id}/messages`,headers:{api_access_token:this.provider.token,...S.getHeaders()},data:S};try{let{data:_}=await $.default.request(c);return _}catch(_){this.logger.error(_)}}async sendAttachment(e,t,s,a,i){try{let o=te.default.parse(decodeURIComponent(s)),n=y.default.lookup(o?.ext)||"",r=o?.name+o?.ext;if(!n){let T=s.split("/");r=decodeURIComponent(T[T.length-1]),n=(await $.default.get(s,{responseType:"arraybuffer"})).headers["content-type"]}let E="document";switch(n.split("/")[0]){case"image":E="image";break;case"video":E="video";break;case"audio":E="audio";break;default:E="document";break}if(E==="audio"){let T={number:t,audio:s,delay:Math.floor(Math.random()*1501)+500,quoted:i?.quoted};return x("/message/sendWhatsAppAudio"),await e?.audioWhatsapp(T,null,!0)}E==="image"&&o&&[".gif",".svg",".tiff",".tif",".dxf",".dwg"].includes(o?.ext)&&(E="document");let c={number:t,mediatype:E,fileName:r,media:s,delay:1200,quoted:i?.quoted};return x("/message/sendMedia"),a&&(c.caption=a),await e?.mediaMessage(c,null,!0)}catch(o){throw this.logger.error(o),o}}async onSendMessageError(e,t,s){this.logger.verbose(`onSendMessageError ${JSON.stringify(s)}`);let a=await this.clientCw(e);if(a){if(s&&s?.status===400&&s?.message[0]?.exists===!1){a.messages.create({accountId:this.provider.accountId,conversationId:t,data:{content:`${u.t("cw.message.numbernotinwhatsapp")}`,message_type:"outgoing",private:!0}});return}a.messages.create({accountId:this.provider.accountId,conversationId:t,data:{content:u.t("cw.message.notsent",{error:s?`_${s.toString()}_`:""}),message_type:"outgoing",private:!0}})}}async receiveWebhook(e,t){try{if(await new Promise(E=>setTimeout(E,500)),!await this.clientCw(e))return this.logger.warn("client not found"),null;if(this.provider.reopenConversation===!1&&t.event==="conversation_status_changed"&&t.status==="resolved"&&t.meta?.sender?.identifier){let E=`${e.instanceName}:createConversation-${t.meta.sender.identifier}`;this.cache.delete(E)}if(!t?.conversation||t.private||t.event==="message_updated"&&!t.content_attributes?.deleted)return{message:"bot"};let a=t.conversation.meta.sender?.identifier||t.conversation.meta.sender?.phone_number.replace("+",""),i=t.content?t.content.replaceAll(/(?<!\*)\*((?!\s)([^\n*]+?)(?<!\s))\*(?!\*)/g,"_$1_").replaceAll(/\*{2}((?!\s)([^\n*]+?)(?<!\s))\*{2}/g,"*$1*").replaceAll(/~{2}((?!\s)([^\n*]+?)(?<!\s))~{2}/g,"~$1~").replaceAll(/(?<!`)`((?!\s)([^`*]+?)(?<!\s))`(?!`)/g,"```$1```"):t.content,o=t?.conversation?.messages[0]?.sender?.available_name||t?.sender?.name,n=this.waMonitor.waInstances[e.instanceName];if(e.instanceId=n.instanceId,t.event==="message_updated"&&t.content_attributes?.deleted){let E=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:t.id,instanceId:e.instanceId}});if(E){let S=E.key;await n?.client.sendMessage(S.remoteJid,{delete:S}),await this.prismaRepository.message.deleteMany({where:{instanceId:e.instanceId,chatwootMessageId:t.id}})}return{message:"bot"}}let r=this.configService.get("CHATWOOT").BOT_CONTACT;if(a==="123456"&&t.message_type==="outgoing"){let E=i.replace("/","");if(r&&(E.includes("init")||E.includes("iniciar")))if(n?.connectionStatus?.state!=="open"){let c=E.split(":")[1];await n.connectToWhatsapp(c)}else await this.createBotMessage(e,u.t("cw.inbox.alreadyConnected",{inboxName:t.inbox.name}),"incoming");if(E==="clearcache"&&(n.clearCacheChatwoot(),await this.createBotMessage(e,u.t("cw.inbox.clearCache",{inboxName:t.inbox.name}),"incoming")),E==="status"){let S=n?.connectionStatus?.state;S||await this.createBotMessage(e,u.t("cw.inbox.notFound",{inboxName:t.inbox.name}),"incoming"),S&&await this.createBotMessage(e,u.t("cw.inbox.status",{inboxName:t.inbox.name,state:S}),"incoming")}if(r&&(E==="disconnect"||E==="desconectar")){let S=u.t("cw.inbox.disconnect",{inboxName:t.inbox.name});await this.createBotMessage(e,S,"incoming"),await n?.client?.logout("Log out instance: "+e.instanceName),await n?.client?.ws?.close()}}if(t.message_type==="outgoing"&&t?.conversation?.messages?.length&&a!=="123456"){if(t?.conversation?.messages[0]?.source_id?.substring(0,5)==="WAID:")return{message:"bot"};if(!n&&t.conversation?.id)return this.onSendMessageError(e,t.conversation?.id,"Instance not found"),{message:"bot"};let E;if(o==null)E=i;else{let c=this.provider.signDelimiter?this.provider.signDelimiter.replaceAll("\\n",`
`):`
`,_=this.provider.signMsg?[`*${o}:*`]:[];_.push(i),E=_.join(c)}for(let c of t.conversation.messages)if(c.attachments&&c.attachments.length>0)for(let _ of c.attachments){i||(E=null);let T={quoted:await this.getQuotedMessage(t,e)},g=await this.sendAttachment(n,a,_.data_url,E,T);!g&&t.conversation?.id&&this.onSendMessageError(e,t.conversation?.id),await this.updateChatwootMessageId({...g},{messageId:t.id,inboxId:t.inbox?.id,conversationId:t.conversation?.id,contactInboxSourceId:t.conversation?.contact_inbox?.source_id},e)}else{let _={number:a,text:E,delay:Math.floor(Math.random()*1501)+500,quoted:await this.getQuotedMessage(t,e)};x("/message/sendText");let T;try{if(T=await n?.textMessage(_,!0),!T)throw new Error("Message not sent");ee.default.isLong(T?.messageTimestamp)&&(T.messageTimestamp=T.messageTimestamp?.toNumber()),await this.updateChatwootMessageId({...T},{messageId:t.id,inboxId:t.inbox?.id,conversationId:t.conversation?.id,contactInboxSourceId:t.conversation?.contact_inbox?.source_id},e)}catch(g){throw!T&&t.conversation?.id&&this.onSendMessageError(e,t.conversation?.id,g),g}}if(this.configService.get("CHATWOOT").MESSAGE_READ){let c=await this.prismaRepository.message.findFirst({where:{key:{path:["fromMe"],equals:!1},instanceId:e.instanceId}});if(c&&!c.chatwootIsRead){let _=c.key;n?.markMessageAsRead({readMessages:[{id:_.id,fromMe:_.fromMe,remoteJid:_.remoteJid}]});let T={chatwootMessageId:c.chatwootMessageId,chatwootConversationId:c.chatwootConversationId,chatwootInboxId:c.chatwootInboxId,chatwootContactInboxSourceId:c.chatwootContactInboxSourceId,chatwootIsRead:!0};await this.prismaRepository.message.updateMany({where:{instanceId:e.instanceId,key:{path:["id"],equals:_.id}},data:T})}}}if(t.message_type==="template"&&t.event==="message_created"){let E={number:a,text:t.content.replace(/\\\r\n|\\\n|\n/g,`
`),delay:Math.floor(Math.random()*1501)+500};x("/message/sendText"),await n?.textMessage(E)}return{message:"bot"}}catch(s){return this.logger.error(s),{message:"bot"}}}async updateChatwootMessageId(e,t,s){let a=e.key;if(!t.messageId||!a?.id)return;let i=await this.prismaRepository.$executeRaw`
      UPDATE "Message" 
      SET 
        "chatwootMessageId" = ${t.messageId},
        "chatwootConversationId" = ${t.conversationId},
        "chatwootInboxId" = ${t.inboxId},
        "chatwootContactInboxSourceId" = ${t.contactInboxSourceId},
        "chatwootIsRead" = ${t.isRead||!1}
      WHERE "instanceId" = ${s.instanceId} 
      AND "key"->>'id' = ${a.id}
    `;if(this.logger.verbose(`Update result: ${i} rows affected`),this.isImportHistoryAvailable())try{await f.updateMessageSourceID(t.messageId,a.id)}catch(o){this.logger.error(`Error updating Chatwoot message source ID: ${o}`)}}async getMessageByKeyId(e,t){return(await this.prismaRepository.$queryRaw`
      SELECT * FROM "Message" 
      WHERE "instanceId" = ${e.instanceId} 
      AND "key"->>'id' = ${t}
      LIMIT 1
    `)[0]||null}async getReplyToIds(e,t){let s=null,a=null;if(e&&(a=e.message?.extendedTextMessage?.contextInfo?.stanzaId??e.contextInfo?.stanzaId,a)){let i=await this.getMessageByKeyId(t,a);i?.chatwootMessageId&&(s=i.chatwootMessageId)}return{in_reply_to:s,in_reply_to_external_id:a}}async getQuotedMessage(e,t){if(e?.content_attributes?.in_reply_to){let s=await this.prismaRepository.message.findFirst({where:{chatwootMessageId:e?.content_attributes?.in_reply_to,instanceId:t.instanceId}}),a=s?.key,i=s?.message;if(i&&a?.id)return{key:a,message:i}}return null}isMediaMessage(e){let t=["imageMessage","documentMessage","documentWithCaptionMessage","audioMessage","videoMessage","stickerMessage","viewOnceMessageV2"];return Object.keys(e).some(i=>t.includes(i))}isInteractiveButtonMessage(e,t){return e==="interactiveMessage"&&t.interactiveMessage?.nativeFlowMessage?.buttons?.length>0}getAdsMessage(e){return{title:e.extendedTextMessage?.contextInfo?.externalAdReply?.title||e.contextInfo?.externalAdReply?.title,body:e.extendedTextMessage?.contextInfo?.externalAdReply?.body||e.contextInfo?.externalAdReply?.body,thumbnailUrl:e.extendedTextMessage?.contextInfo?.externalAdReply?.thumbnailUrl||e.contextInfo?.externalAdReply?.thumbnailUrl,sourceUrl:e.extendedTextMessage?.contextInfo?.externalAdReply?.sourceUrl||e.contextInfo?.externalAdReply?.sourceUrl}}getReactionMessage(e){return e?.reactionMessage}getTypeMessage(e){return{conversation:e.conversation,imageMessage:e.imageMessage?.caption,videoMessage:e.videoMessage?.caption,extendedTextMessage:e.extendedTextMessage?.text,messageContextInfo:e.messageContextInfo?.stanzaId,stickerMessage:void 0,documentMessage:e.documentMessage?.caption,documentWithCaptionMessage:e.documentWithCaptionMessage?.message?.documentMessage?.caption,audioMessage:e.audioMessage?e.audioMessage.caption??"":void 0,contactMessage:e.contactMessage?.vcard,contactsArrayMessage:e.contactsArrayMessage,locationMessage:e.locationMessage,liveLocationMessage:e.liveLocationMessage,listMessage:e.listMessage,listResponseMessage:e.listResponseMessage,viewOnceMessageV2:e?.message?.viewOnceMessageV2?.message?.imageMessage?.url||e?.message?.viewOnceMessageV2?.message?.videoMessage?.url||e?.message?.viewOnceMessageV2?.message?.audioMessage?.url}}getMessageContent(e){let t=Object.keys(e).find(a=>e[a]!==void 0),s=t?e[t]:void 0;if(s&&typeof s=="string"&&s.includes("externalAdReplyBody|")&&(s=s.split("externalAdReplyBody|").filter(Boolean).join("")),t==="locationMessage"||t==="liveLocationMessage"){let a=s.degreesLatitude,i=s.degreesLongitude,o=s?.name,n=s?.address;return`*${u.t("cw.locationMessage.location")}:*

_${u.t("cw.locationMessage.latitude")}:_ ${a} 
_${u.t("cw.locationMessage.longitude")}:_ ${i} 
`+(o?`_${u.t("cw.locationMessage.locationName")}:_ ${o}
`:"")+(n?`_${u.t("cw.locationMessage.locationAddress")}:_ ${n} 
`:"")+`_${u.t("cw.locationMessage.locationUrl")}:_ https://www.google.com/maps/search/?api=1&query=${a},${i}`}if(t==="contactMessage"){let a=s.split(`
`),i={};a.forEach(r=>{let[E,S]=r.split(":");E&&S&&(i[E]=S)});let o=`*${u.t("cw.contactMessage.contact")}:*

_${u.t("cw.contactMessage.name")}:_ ${i.FN}`,n=1;return Object.keys(i).forEach(r=>{if(r.startsWith("item")&&r.includes("TEL")){let E=i[r];o+=`
_${u.t("cw.contactMessage.number")} (${n}):_ ${E}`,n++}else if(r.includes("TEL")){let E=i[r];o+=`
_${u.t("cw.contactMessage.number")} (${n}):_ ${E}`,n++}}),o}if(t==="contactsArrayMessage")return s.contacts.map(o=>{let n=o.vcard.split(`
`),r={};n.forEach(c=>{let[_,T]=c.split(":");_&&T&&(r[_]=T)});let E=`*${u.t("cw.contactMessage.contact")}:*

_${u.t("cw.contactMessage.name")}:_ ${o.displayName}`,S=1;return Object.keys(r).forEach(c=>{if(c.startsWith("item")&&c.includes("TEL")){let _=r[c];E+=`
_${u.t("cw.contactMessage.number")} (${S}):_ ${_}`,S++}else if(c.includes("TEL")){let _=r[c];E+=`
_${u.t("cw.contactMessage.number")} (${S}):_ ${_}`,S++}}),E}).join(`

`);if(t==="listMessage"){let a=s?.title||"Unknown",i=s?.description||"Unknown",o=s?.footerText||"Unknown",n=`*List Menu:*

_Title_: `+a+`
_Description_: `+i+`
_Footer_: `+o;return s.sections&&s.sections.length>0?s.sections.forEach((r,E)=>{n+=`

*Section `+(E+1)+":* "+r.title||`Unknown
`,r.rows&&r.rows.length>0?r.rows.forEach((S,c)=>{n+=`
*Line `+(c+1)+`:*
`,n+="_\u25AA\uFE0F Title:_ "+(S.title||"Unknown")+`
`,n+="_\u25AA\uFE0F Description:_ "+(S.description||"Unknown")+`
`,n+="_\u25AA\uFE0F ID:_ "+(S.rowId||"Unknown")+`
`}):n+=`
No lines found in this section.
`}):n+=`
No sections found.
`,n}if(t==="listResponseMessage"){let a=s?.title||"Unknown",i=s?.description||"Unknown",o=s?.singleSelectReply?.selectedRowId||"Unknown";return`*List Response:*

_Title_: `+a+`
_Description_: `+i+`
_ID_: `+o}return s}getConversationMessage(e){let t=this.getTypeMessage(e);return this.getMessageContent(t)}async eventWhatsapp(e,t,s){try{let a=this.waMonitor.waInstances[t.instanceName];if(!a)return this.logger.warn("wa instance not found"),null;let i=await this.clientCw(t);if(!i)return this.logger.warn("client not found"),null;if(this.provider?.ignoreJids&&this.provider?.ignoreJids.length>0){let o=this.provider?.ignoreJids,n=!1,r=!1;if(o.includes("@g.us")&&(n=!0),o.includes("@s.whatsapp.net")&&(r=!0),n&&s?.key?.remoteJid.endsWith("@g.us")){this.logger.warn("Ignoring message from group: "+s?.key?.remoteJid);return}if(r&&s?.key?.remoteJid.endsWith("@s.whatsapp.net")){this.logger.warn("Ignoring message from contact: "+s?.key?.remoteJid);return}if(o.includes(s?.key?.remoteJid)){this.logger.warn("Ignoring message from jid: "+s?.key?.remoteJid);return}}if(e==="messages.upsert"||e==="send.message"){if(this.logger.info(`[${e}] New message received - Instance: ${JSON.stringify(s,null,2)}`),s.key.remoteJid==="status@broadcast")return;s.message?.ephemeralMessage?.message&&(s.message={...s.message?.ephemeralMessage?.message});let o=await this.getConversationMessage(s.message),n=o&&o.replaceAll(/\*((?!\s)([^\n*]+?)(?<!\s))\*/g,"**$1**").replaceAll(/_((?!\s)([^\n_]+?)(?<!\s))_/g,"*$1*").replaceAll(/~((?!\s)([^\n~]+?)(?<!\s))~/g,"~~$1~~");if(n&&n.includes("/survey/responses/")&&n.includes("http"))return;let r=s.contextInfo?.stanzaId||s.message?.contextInfo?.stanzaId,E=null;r&&(E=await this.prismaRepository.message.findFirst({where:{key:{path:["id"],equals:r},chatwootMessageId:{not:null}}}));let S=this.isMediaMessage(s.message),c=this.getAdsMessage(s),_=this.getReactionMessage(s.message),T=this.isInteractiveButtonMessage(s.messageType,s.message);if(!n&&!S&&!_&&!T){this.logger.warn("no body message found");return}let g=await this.createConversation(t,s);if(!g){this.logger.warn("conversation not found");return}let A=s.key.fromMe?"outgoing":"incoming";if(S){let d=await a?.getBase64FromMediaMessage({message:{...s}}),l,R=s?.message[s?.messageType],h=R?.fileName||R?.filename||R?.message?.documentMessage?.fileName;if(h){let N=te.default.parse(h);N.name&&N.ext&&(l=`${N.name}-${Math.floor(Math.random()*90+10)}${N.ext}`)}l||(l=`${Math.random().toString(36).substring(7)}.${y.default.extension(d.mimetype)||""}`);let p=Buffer.from(d.base64,"base64"),m=new W.Readable;if(m._read=()=>{},m.push(p),m.push(null),s.key.remoteJid.includes("@g.us")){let N=s.pushName,O=s.key.addressingMode==="lid"&&!s.key.fromMe&&s.key.participantAlt?s.key.participantAlt.split("@")[0].split(":")[0]:s.key.participant.split("@")[0].split(":")[0],P=(0,Z.parsePhoneNumberFromString)(`+${O}`).formatInternational(),L;s.key.fromMe?L=n||"":L=n?`**${P} - ${N}:**

${n}`:`**${P} - ${N}:**`;let B=await this.sendData(g,m,l,A,L,t,s,"WAID:"+s.key.id,E);if(!B){this.logger.warn("message not sent");return}return B}else{let N=await this.sendData(g,m,l,A,n,t,s,"WAID:"+s.key.id,E);if(!N){this.logger.warn("message not sent");return}return N}}if(_){if(_.text&&!await this.createMessage(t,g,_.text,A,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:_.key.id}}}},"WAID:"+s.key.id,E)){this.logger.warn("message not sent");return}return}if(T){let d=s.message.interactiveMessage.nativeFlowMessage.buttons;this.logger.info("is Interactive Button Message: "+JSON.stringify(d));for(let l of d){let h=JSON.parse(l.buttonParamsJson).payment_settings;if(l.name==="payment_info"&&h[0].type==="pix_static_code"){let p=h[0].pix_static_code,m=(()=>{switch(p.key_type){case"EVP":return"Chave Aleat\xF3ria";case"EMAIL":return"E-mail";case"PHONE":return"Telefone";default:return p.key_type}})(),N=p.key_type==="PHONE"?p.key.replace("+55",""):p.key,O=`*${p.merchant_name}*
Chave PIX: ${N} (${m})`;await this.createMessage(t,g,O,A,!1,[],s,"WAID:"+s.key.id,E)||this.logger.warn("message not sent")}else this.logger.warn("Interactive Button Message not mapped")}return}if(c&&c.title||c.body||c.thumbnailUrl){let d=await $.default.get(c.thumbnailUrl,{responseType:"arraybuffer"}),l=y.default.extension(d.headers["content-type"]),R=l&&y.default.lookup(l);if(!R){this.logger.warn("mimetype of Ads message not found");return}let p=`${Math.random().toString(36).substring(7)}.${y.default.extension(R)}`,m=Buffer.from(d.data,"binary"),N=await F.Jimp.read(m);await N.cover({w:320,h:180});let O=await N.getBuffer(F.JimpMime.png),P=new W.Readable;P._read=()=>{},P.push(O),P.push(null);let L=(U,ne)=>U?U.length>ne?U.substring(0,ne)+"...":U:"",B=L(c.title,40),k=L(c?.body,75),V=await this.sendData(g,P,p,A,`${n}


**${B}**
${k}
${c.sourceUrl}`,t,s,"WAID:"+s.key.id);if(!V){this.logger.warn("message not sent");return}return V}if(s.key.remoteJid.includes("@g.us")){let d=s.pushName,l=s.key.addressingMode==="lid"&&!s.key.fromMe&&s.key.participantAlt?s.key.participantAlt.split("@")[0].split(":")[0]:s.key.participant.split("@")[0].split(":")[0],R=(0,Z.parsePhoneNumberFromString)(`+${l}`).formatInternational(),h;s.key.fromMe?h=`${n}`:h=`**${R} - ${d}:**

${n}`;let p=await this.createMessage(t,g,h,A,!1,[],s,"WAID:"+s.key.id,E);if(!p){this.logger.warn("message not sent");return}return p}else{let d=await this.createMessage(t,g,n,A,!1,[],s,"WAID:"+s.key.id,E);if(!d){this.logger.warn("message not sent");return}return d}}if(e==="messages.delete"&&this.configService.get("CHATWOOT").MESSAGE_DELETE===!0){if(!s?.key?.id){this.logger.warn("message id not found");return}let n=await this.getMessageByKeyId(t,s.key.id);if(n?.chatwootMessageId&&n?.chatwootConversationId)return await this.prismaRepository.message.deleteMany({where:{key:{path:["id"],equals:s.key.id},instanceId:t.instanceId}}),await i.messages.delete({accountId:this.provider.accountId,conversationId:n.chatwootConversationId,messageId:n.chatwootMessageId})}if(e==="messages.edit"||e==="send.message.update"){let n=(s?.editedMessage?.conversation??s?.editedMessage?.extendedTextMessage?.text??s?.editedMessage?.imageMessage?.caption??s?.editedMessage?.videoMessage?.caption??s?.editedMessage?.documentMessage?.caption??(typeof s?.text=="string"?s.text:void 0)??"").trim();if(!n){this.logger.info("[CW.EDIT] Conte\xFAdo vazio \u2014 ignorando (DELETE tratar\xE1 se for revoke).");return}let r=await this.getMessageByKeyId(t,s?.key?.id);if(!r){this.logger.warn("Message not found for edit event");return}let E=r.key,S=E?.fromMe?"outgoing":"incoming";if(r&&r.chatwootConversationId&&r.chatwootMessageId){let c=`

\`${u.t("cw.message.edited")}:\`

${n}`;if(!await this.createMessage(t,r.chatwootConversationId,c,S,!1,[],{message:{extendedTextMessage:{contextInfo:{stanzaId:E.id}}}},"WAID:"+s.key.id,null)){this.logger.warn("edited message not sent");return}}return}if(e==="messages.read"){if(!s?.key?.id||!s?.key?.remoteJid){this.logger.warn("message id not found");return}let o=await this.getMessageByKeyId(t,s.key.id),n=o?.chatwootConversationId,r=o?.chatwootContactInboxSourceId;if(n){let E=r,S=await this.getInbox(t);if(!E&&S&&(E=(await i.conversations.get({accountId:this.provider.accountId,conversationId:n})).last_non_activity_message?.conversation?.contact_inbox?.source_id),E&&S?.inbox_identifier){let c=`/public/api/v1/inboxes/${S.inbox_identifier}/contacts/${E}/conversations/${n}/update_last_seen`;await(0,H.request)(this.getClientCwConfig(),{method:"POST",url:c})}}return}if(e==="status.instance"){let o=s,n=await this.getInbox(t);if(!n){this.logger.warn("inbox not found");return}let r=u.t("cw.inbox.status",{inboxName:n.name,state:o.status});await this.createBotMessage(t,r,"incoming")}if(e==="connection.update"&&s.status==="open"){let o=this.waMonitor.waInstances[t.instanceName];if(!o)return;let n=Date.now(),r=n-(o.lastConnectionNotification||0);if(o.qrCode&&o.qrCode.count>0){let E=u.t("cw.inbox.connected");await this.createBotMessage(t,E,"incoming"),o.qrCode.count=0,o.lastConnectionNotification=n,f.clearAll(t)}else if(r>=3e4){let E=u.t("cw.inbox.connected");await this.createBotMessage(t,E,"incoming"),o.lastConnectionNotification=n}else this.logger.warn(`Connection notification skipped for ${t.instanceName} - too frequent (${r}ms since last)`)}if(e==="qrcode.updated")if(s.statusCode===500){let o=`\u{1F6A8} ${u.t("qrlimitreached")}`;return await this.createBotMessage(t,o,"incoming")}else{let o=Buffer.from(s?.qrcode.base64.replace("data:image/png;base64,",""),"base64"),n=new W.Readable;n._read=()=>{},n.push(o),n.push(null),await this.createBotQr(t,u.t("qrgeneratedsuccesfully"),"incoming",n,`${t.instanceName}.png`);let r=`\u26A1\uFE0F${u.t("qrgeneratedsuccesfully")}

${u.t("scanqr")}`;s?.qrcode?.pairingCode&&(r=r+`

*Pairing Code:* ${s.qrcode.pairingCode.substring(0,4)}-${s.qrcode.pairingCode.substring(4,8)}`),await this.createBotMessage(t,r,"incoming")}}catch(a){this.logger.error(a)}}normalizeJidIdentifier(e){return e?e.includes("@lid")?e:e.replace(/:\d+/,"").split("@")[0]:""}startImportHistoryMessages(e){this.isImportHistoryAvailable()&&this.createBotMessage(e,u.t("cw.import.startImport"),"incoming")}isImportHistoryAvailable(){let e=this.configService.get("CHATWOOT").IMPORT.DATABASE.CONNECTION.URI;return e&&e!=="postgres://user:password@hostname:port/dbname"}addHistoryMessages(e,t){this.isImportHistoryAvailable()&&f.addHistoryMessages(e,t)}addHistoryContacts(e,t){if(this.isImportHistoryAvailable())return f.addHistoryContacts(e,t)}async importHistoryMessages(e){if(!this.isImportHistoryAvailable())return;this.createBotMessage(e,u.t("cw.import.importingMessages"),"incoming");let t=await f.importHistoryMessages(e,this,await this.getInbox(e),this.provider);this.updateContactAvatarInRecentConversations(e);let s=Number.isInteger(t)?u.t("cw.import.messagesImported",{totalMessagesImported:t}):u.t("cw.import.messagesException");return this.createBotMessage(e,s,"incoming"),t}async updateContactAvatarInRecentConversations(e,t=100){try{if(!this.isImportHistoryAvailable())return;let s=await this.clientCw(e);if(!s)return this.logger.warn("client not found"),null;let a=await this.getInbox(e);if(!a)return this.logger.warn("inbox not found"),null;let i=await f.getContactsOrderByRecentConversations(a,this.provider,t),o=i.map(r=>r.identifier).filter(r=>r!==null),n=(await this.prismaRepository.contact.findMany({where:{instanceId:e.instanceId,id:{in:o},profilePicUrl:{not:null}}})).reduce((r,E)=>r.set(E.id,E),new Map);i.forEach(async r=>{n.has(r.identifier)&&s.contacts.update({accountId:this.provider.accountId,id:r.id,data:{avatar_url:n.get(r.identifier).profilePictureUrl||null}})})}catch(s){this.logger.error(`Error on update avatar in recent conversations: ${s.toString()}`)}}async syncLostMessages(e,t,s){try{if(!this.isImportHistoryAvailable()||!this.configService.get("DATABASE").SAVE_DATA.MESSAGE_UPDATE)return;let a=await this.getInbox(e),i=`select * from messages m
      where account_id = ${t.accountId}
      and inbox_id = ${a.id}
      and created_at >= now() - interval '6h'
      order by created_at desc`,n=((await this.pgClient.query(i))?.rows).filter(_=>!!_.source_id).map(_=>_.source_id.replace("WAID:","")),E=(await this.prismaRepository.message.findMany({where:{Instance:{name:e.instanceName},messageTimestamp:{gte:Number((0,ue.default)().subtract(6,"hours").unix())},AND:n.map(_=>({key:{path:["id"],not:_}}))}})).filter(_=>!f.isIgnorePhoneNumber(_.key?.remoteJid)),S=[];for(let _ of E)!_.message||!_.key||!_.messageTimestamp||(ee.default.isLong(_?.messageTimestamp)&&(_.messageTimestamp=_.messageTimestamp?.toNumber()),S.push(s(_)));this.addHistoryMessages(e,S.filter(_=>!f.isIgnorePhoneNumber(_.key?.remoteJid))),await f.importHistoryMessages(e,this,a,this.provider),this.waMonitor.waInstances[e.instanceName].clearCacheChatwoot()}catch{return}}};0&&(module.exports={ChatwootService});
//# sourceMappingURL=chatwoot.service.js.map